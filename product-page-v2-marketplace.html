<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dynamic Product Page - Energy Calculator - v2.0 (Marketplace Test)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        .product-page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Breadcrumb */
        .breadcrumb {
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breadcrumb a {
            color: #007bff;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Back Button */
        .back-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .back-button:hover {
            background: #0056b3;
        }

        .back-button:active {
            transform: scale(0.98);
        }

        /* Main Product Section */
        .product-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Product Image */
        .product-image-section {
            position: relative;
        }

        .product-image {
            width: 100%;
            height: 400px;
            object-fit: contain;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .image-placeholder {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #6c757d;
        }

        .image-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dee2e6;
            cursor: pointer;
        }

        .dot.active {
            background: #007bff;
        }

        /* Product Details */
        /* Product Media Gallery */
        .product-media-section {
            position: relative;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .main-media-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
        }

        .main-media-image,
        .main-media-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #f8f9fa;
        }

        .main-media-image:hover {
            /* No zoom on hover - keeps image in frame */
        }

        .main-media-video {
            background: #000;
        }

        .media-placeholder {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 16px;
            font-weight: 500;
        }

        .media-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .media-control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .media-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .media-counter {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .media-thumbnails {
            display: flex;
            gap: 8px;
            padding: 15px;
            overflow-x: auto;
            background: #f8f9fa;
        }

        .media-thumbnail {
            min-width: 80px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s ease;
            position: relative;
        }

        .media-thumbnail.active {
            border-color: #007bff;
        }

        .media-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #fff;
        }

        .media-thumbnail.video::after {
            content: "‚ñ∂";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .media-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .media-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .media-dot.active {
            background: #007bff;
        }

        .product-details {
            padding: 20px 0;
        }

        .product-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #212529;
        }

        .product-sku {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .product-price {
            font-size: 32px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 20px;
        }

        .product-description {
            margin-bottom: 25px;
        }

        .description-text {
            font-size: 16px;
            line-height: 1.6;
            color: #495057;
        }

        .description-short {
            display: block;
        }

        .description-full {
            display: none;
        }

        .read-more-btn {
            color: #007bff;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
            display: inline-block;
        }

        .read-more-btn:hover {
            text-decoration: underline;
        }

        /* Quantity and Add to Cart */
        .quantity-section {
            margin-bottom: 25px;
        }

        .quantity-label {
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-input {
            display: flex;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

        .quantity-btn {
            background: #f8f9fa;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }

        .quantity-btn:hover {
            background: #e9ecef;
        }

        .quantity-number {
            border: none;
            padding: 12px 20px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            width: 80px;
        }

        .add-to-cart-btn {
            background: #fd7e14;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .add-to-cart-btn:hover {
            background: #e8590c;
        }

        .video-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .video-btn:hover {
            background: #0056b3;
        }

        /* MARKETPLACE BUTTON STYLES */
        .marketplace-buy-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: transform 0.3s ease;
            font-size: 16px;
        }

        .marketplace-buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .marketplace-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .marketplace-message-success {
            background: #28a745;
        }

        .marketplace-message-error {
            background: #dc3545;
        }

        .marketplace-message-info {
            background: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Social Sharing */
        .social-sharing {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .social-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .social-btn:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        /* Tech Information Section */
        .tech-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .tech-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #212529;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .tech-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .tech-item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #212529;
        }

        .tech-item-value {
            color: #495057;
            font-size: 16px;
        }

        /* Additional Technical Information Dropdown */
        .additional-tech-container {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
        }

        .additional-tech-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .additional-tech-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .additional-tech-btn.expanded {
            background: #1e7e34;
        }

        .additional-tech-btn.expanded:hover {
            background: #155724;
        }

        /* Additional Technical Information - Darker green */
        #additional-tech-btn.expanded {
            background: #1e7e34;
        }

        #additional-tech-btn.expanded:hover {
            background: #155724;
        }

        /* Additional Information - Slightly different dark green */
        #additional-info-btn.expanded {
            background: #155724;
        }

        #additional-info-btn.expanded:hover {
            background: #0d4f1c;
        }

        .additional-tech-panel {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .additional-tech-panel.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .additional-tech-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #212529;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .additional-tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .additional-tech-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .additional-tech-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #212529;
            font-size: 14px;
        }

        .additional-tech-item-value {
            color: #495057;
            font-size: 14px;
        }

        /* Additional Information */
        .additional-info {
            margin-top: 30px;
        }

        .additional-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #212529;
        }

        .additional-info ul {
            list-style: none;
            padding: 0;
        }

        .additional-info li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
        }

        .additional-info li:last-child {
            border-bottom: none;
        }

        .additional-info li::before {
            content: "‚Ä¢";
            color: #007bff;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Calculator Widget Integration */
        .calculator-widget {
            margin-top: 30px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }

        .calculator-widget iframe {
            width: 100%;
            height: 800px;
            border: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .product-page-container {
                padding: 10px;
            }
            
            .product-main {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .product-title {
                font-size: 24px;
            }

            .product-price {
                font-size: 28px;
            }

            .tech-grid {
                grid-template-columns: 1fr;
            }

            .quantity-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .add-to-cart-btn {
                width: 100%;
            }
            
            .calculator-widget iframe {
                height: 600px;
            }
            
            .tech-section {
                padding: 20px;
            }
            
            .additional-tech-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .product-page-container {
                padding: 5px;
            }
            
            .product-title {
                font-size: 20px;
            }

            .product-price {
                font-size: 24px;
            }
            
            .calculator-widget iframe {
                height: 500px;
            }
            
            .tech-section {
                padding: 15px;
            }
            
            .breadcrumb {
                font-size: 12px;
            }
            
            .social-sharing {
                justify-content: center;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="product-page-container">
        <!-- Breadcrumb with Back Button -->
        <nav class="breadcrumb">
            <button onclick="goBack()" class="back-button" title="Go back to previous page">‚Üê Back</button>
            <a href="/product-categories.html" id="breadcrumb-category-link">Products</a> / 
            <span id="breadcrumb-product">Loading...</span>
        </nav>

        <!-- Main Product Section -->
        <div class="product-main">
            <!-- Product Media Gallery -->
            <div class="product-media-section">
                <!-- Main Media Display -->
                <div class="main-media-container">
                    <img id="main-media" class="main-media-image" src="" alt="Product Image" style="display: none;">
                    <video id="main-media-video" class="main-media-video" controls style="display: none;">
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div id="media-placeholder" class="media-placeholder">
                        Loading product media...
                    </div>
                    
                    <!-- Media Controls -->
                    <div class="media-controls">
                        <button id="play-pause-btn" class="media-control-btn" onclick="togglePlayPause()" style="display: none;">
                            <span id="play-icon">‚ñ∂</span>
                        </button>
                        <div class="media-counter">
                            <span id="current-media">1</span> / <span id="total-media">1</span>
                        </div>
                    </div>
                </div>

                <!-- Media Thumbnails -->
                <div class="media-thumbnails" id="media-thumbnails">
                    <!-- Thumbnails will be dynamically generated -->
                </div>

                <!-- Media Navigation Dots -->
                <div class="media-dots" id="media-dots">
                    <!-- Dots will be dynamically generated -->
                </div>
            </div>

            <!-- Product Details -->
            <div class="product-details">
                <h1 id="product-title" class="product-title">Loading product...</h1>
                <div id="product-sku" class="product-sku">SKU: Loading...</div>
                <div id="product-price" class="product-price">‚Ç¨0.00</div>
                
                <div class="product-description">
                    <div id="description-short" class="description-text description-short">
                        Loading product description...
                    </div>
                    <div id="description-full" class="description-text description-full">
                        <!-- Full description will be loaded here -->
                    </div>
                    <span id="read-more-btn" class="read-more-btn" onclick="toggleDescription()" style="display: none;">
                        Read more
                    </span>
                </div>

                <div class="quantity-section">
                    <label class="quantity-label">Quantity:</label>
                    <div class="quantity-controls">
                        <div class="quantity-input">
                            <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                            <input type="number" id="quantity" class="quantity-number" value="1" min="1">
                            <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                        </div>
                        <button class="video-btn" onclick="showVideo()">
                            üìπ Watch Video
                        </button>
                        <button class="add-to-cart-btn" onclick="addToCart()">
                            Add to Cart
                        </button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="financial-incentives-btn" onclick="showFinancialIncentives()">
                            üí∂ See Financial Incentives
                        </button>
                    </div>
                </div>

                <div class="social-sharing">
                    <div class="social-btn" onclick="shareOnFacebook()">f</div>
                    <div class="social-btn" onclick="shareOnWhatsApp()">w</div>
                    <div class="social-btn" onclick="shareGeneric()">‚Üó</div>
                </div>

                <!-- Main Marketplace Buy Button -->
                <button class="marketplace-buy-btn" onclick="handleMainProductBuy()" style="margin-top: 20px;">
                    üõí Buy This Product - ‚Ç¨1,299
                </button>
            </div>
        </div>

        <!-- Tech Information Section -->
        <div class="tech-section">
            <h2 class="tech-title">‚öôÔ∏è Technical Information</h2>
            
            <div class="tech-grid">
                <div class="tech-item">
                    <div id="tech-power-label" class="tech-item-title">‚ö° Power Rating</div>
                    <div id="tech-power" class="tech-item-value">Loading...</div>
                </div>
                <div class="tech-item">
                    <div class="tech-item-title">üè∑Ô∏è Brand</div>
                    <div id="tech-brand" class="tech-item-value">Loading...</div>
                </div>
                <div class="tech-item">
                    <div class="tech-item-title">üìÇ Category</div>
                    <div id="tech-category" class="tech-item-value">Loading...</div>
                </div>
                <div class="tech-item">
                    <div class="tech-item-title">üî¢ Model Number</div>
                    <div id="tech-model" class="tech-item-value">Loading...</div>
                </div>
                <div class="tech-item">
                    <div class="tech-item-title">‚≠ê Energy Rating</div>
                    <div id="tech-energy-rating" class="tech-item-value">Loading...</div>
                </div>
                <div class="tech-item">
                    <div class="tech-item-title">‚úÖ Efficiency</div>
                    <div id="tech-efficiency" class="tech-item-value">Loading...</div>
                </div>
            </div>

            <!-- Additional Information Dropdowns -->
            <div class="additional-tech-container">
                <button id="additional-tech-btn" class="additional-tech-btn" onclick="toggleAdditionalTech()">
                    <span id="additional-tech-text">üîß Additional Technical Information</span>
                    <span id="additional-tech-icon">‚ñº</span>
                </button>
                <button id="additional-info-btn" class="additional-tech-btn" onclick="toggleAdditionalInfo()" style="margin-left: 15px;">
                    <span id="additional-info-text">üìã Additional Information</span>
                    <span id="additional-info-icon">‚ñº</span>
                </button>
            </div>

            <div id="additional-tech-panel" class="additional-tech-panel">
                <h3 class="additional-tech-title">üîß Detailed Technical Specifications</h3>
                <div id="additional-tech-grid" class="additional-tech-grid">
                    <!-- Additional technical information will be loaded here -->
                </div>
            </div>

            <div id="additional-info-panel" class="additional-tech-panel">
                <h3 class="additional-tech-title">üìã Product Information & Benefits</h3>
                <div id="additional-info-grid" class="additional-tech-grid">
                    <!-- Additional information will be loaded here -->
                </div>
            </div>

            <!-- Additional Information -->
            <div class="additional-info">
                <h3>‚ÑπÔ∏è Additional Information</h3>
                <ul id="additional-info-list">
                    <li>Loading additional information...</li>
                </ul>
            </div>

            <!-- Energy Calculator Widget -->
            <div class="calculator-widget">
                <iframe id="calculator-iframe" src="" width="100%" height="800" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <!-- Financial Incentives Modal -->
    <div id="financial-incentives-modal" class="financial-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; overflow-y: auto;">
        <div class="financial-modal-content" style="background: white; margin: 50px auto; padding: 30px; max-width: 800px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;">
            <span class="financial-modal-close" onclick="closeFinancialIncentives()" style="position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; color: #999; cursor: pointer; line-height: 1;">&times;</span>
            <h2 style="color: #28a745; margin-bottom: 25px; font-size: 28px;">üí∂ Financial Incentives</h2>
            <div id="financial-incentives-content">
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 15px; color: #666;">Loading financial incentives...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .financial-incentives-btn {
            background: #6b8e6b;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            width: 100%;
        }

        .financial-incentives-btn:hover {
            background: #5a7c5a;
        }
        .financial-modal-content h3 {
            color: #28a745;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
        }
        .financial-card {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .financial-card h4 {
            color: #28a745;
            margin-bottom: 10px;
        }
        .grant-item {
            background: white;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        .grant-item h5 {
            color: #007bff;
            margin-bottom: 8px;
        }
        .grant-amount {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }
    </style>

    <!-- SAFE MARKETPLACE INTEGRATION SCRIPT -->
    <script>
        // SAFE Marketplace Integration - No Calculator Conflicts
        // This creates a separate marketplace system that doesn't interfere with existing calculator

        class SafeMarketplaceIntegration {
            constructor() {
                this.isInitialized = false;
                this.calculatorProtected = true;
            }

            // Initialize marketplace WITHOUT touching calculator
            initMarketplace() {
                if (this.isInitialized) {
                    console.log('‚ö†Ô∏è Marketplace already initialized');
                    return;
                }

                console.log('üõ°Ô∏è Initializing SAFE marketplace integration...');
                
                // Only add marketplace features to product pages
                this.addMarketplaceToProductPages();
                this.setupAffiliateTracking();
                
                this.isInitialized = true;
                console.log('‚úÖ Marketplace initialized safely - Calculator untouched');
            }

            // Add marketplace features ONLY to product pages (not calculator)
            addMarketplaceToProductPages() {
                // Check if we're on a product page (not calculator)
                if (this.isCalculatorPage()) {
                    console.log('üõ°Ô∏è Skipping marketplace on calculator page - Calculator protected');
                    return;
                }

                // Only add to product pages
                if (this.isProductPage()) {
                    this.addBuyNowButtons();
                    this.addAffiliateLinks();
                    console.log('‚úÖ Marketplace features added to product page');
                }
            }

            // Check if current page is calculator
            isCalculatorPage() {
                const title = document.title.toLowerCase();
                const url = window.location.href.toLowerCase();
                
                return title.includes('calculator') || 
                       url.includes('calculator') ||
                       document.querySelector('.calculator-grid') !== null;
            }

            // Check if current page is product page
            isProductPage() {
                return document.querySelector('.product-main') !== null ||
                       document.querySelector('.product-page-container') !== null ||
                       document.querySelector('#product-details') !== null;
            }

            // Add "Buy Now" buttons to product pages
            addBuyNowButtons() {
                const productCards = document.querySelectorAll('.tech-item, .additional-tech-item');
                
                productCards.forEach(card => {
                    // Don't add if button already exists
                    if (card.querySelector('.marketplace-buy-btn')) return;
                    
                    const buyButton = document.createElement('button');
                    buyButton.className = 'marketplace-buy-btn';
                    buyButton.innerHTML = 'üõí Buy Now';
                    
                    buyButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleBuyNowClick(card);
                    });
                    
                    card.appendChild(buyButton);
                });

                // Also add to main product section
                const productDetails = document.querySelector('.product-details');
                if (productDetails && !productDetails.querySelector('.marketplace-buy-btn')) {
                    const mainBuyButton = document.createElement('button');
                    mainBuyButton.className = 'marketplace-buy-btn';
                    mainBuyButton.innerHTML = 'üõí Buy This Product';
                    mainBuyButton.style.marginTop = '20px';
                    
                    mainBuyButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleMainProductBuy();
                    });
                    
                    productDetails.appendChild(mainBuyButton);
                }
            }

            // Handle buy now click with affiliate tracking
            handleBuyNowClick(productCard) {
                const productName = productCard.querySelector('.tech-item-title, .additional-tech-item-title')?.textContent || 'Unknown Product';
                const manufacturer = this.determineManufacturer(productName);
                
                if (!manufacturer) {
                    this.showMarketplaceMessage('Product manufacturer not found. Please contact support.', 'error');
                    return;
                }

                // Track the click
                this.trackAffiliateClick(productName, manufacturer);
                
                // Generate affiliate link
                const affiliateLink = this.generateAffiliateLink(productName, manufacturer);
                
                if (affiliateLink) {
                    // Open in new tab to keep user on your site
                    window.open(affiliateLink, '_blank');
                    
                    // Show success message
                    this.showMarketplaceMessage(`Redirecting to ${manufacturer} for purchase...`, 'success');
                } else {
                    this.showMarketplaceMessage('Unable to generate purchase link. Please try again.', 'error');
                }
            }

            // Handle main product buy
            handleMainProductBuy() {
                const productName = document.getElementById('product-title')?.textContent || 'Unknown Product';
                const manufacturer = this.determineManufacturer(productName);
                
                if (!manufacturer) {
                    this.showMarketplaceMessage('Product manufacturer not found. Please contact support.', 'error');
                    return;
                }

                // Track the click
                this.trackAffiliateClick(productName, manufacturer);
                
                // Generate affiliate link
                const affiliateLink = this.generateAffiliateLink(productName, manufacturer);
                
                if (affiliateLink) {
                    // Open in new tab to keep user on your site
                    window.open(affiliateLink, '_blank');
                    
                    // Show success message
                    this.showMarketplaceMessage(`Redirecting to ${manufacturer} for purchase...`, 'success');
                } else {
                    this.showMarketplaceMessage('Unable to generate purchase link. Please try again.', 'error');
                }
            }

            // Determine manufacturer from product name
            determineManufacturer(productName) {
                const name = productName.toLowerCase();
                
                if (name.includes('bosch')) return 'bosch';
                if (name.includes('siemens')) return 'siemens';
                if (name.includes('hobart')) return 'hobart';
                if (name.includes('adande')) return 'adande';
                if (name.includes('whirlpool')) return 'whirlpool';
                if (name.includes('lg')) return 'lg';
                if (name.includes('samsung')) return 'samsung';
                
                return null;
            }

            // Generate affiliate link (safe version)
            generateAffiliateLink(productName, manufacturer) {
                const affiliateIds = {
                    'bosch': 'ETL_MARKETPLACE_001',
                    'siemens': 'ETL_MARKETPLACE_002',
                    'hobart': 'ETL_MARKETPLACE_003',
                    'adande': 'ETL_MARKETPLACE_004'
                };
                
                const affiliateId = affiliateIds[manufacturer];
                if (!affiliateId) return null;
                
                // Simple affiliate link generation (no complex API calls)
                const baseUrls = {
                    'bosch': 'https://www.bosch.com',
                    'siemens': 'https://www.siemens.com',
                    'hobart': 'https://www.hobart.co.uk',
                    'adande': 'https://www.adande.com'
                };
                
                const baseUrl = baseUrls[manufacturer];
                if (!baseUrl) return null;
                
                return `${baseUrl}/products?affiliate=${affiliateId}&source=greenways_market&product=${encodeURIComponent(productName)}`;
            }

            // Track affiliate click (safe version)
            trackAffiliateClick(productName, manufacturer) {
                const clickData = {
                    timestamp: new Date().toISOString(),
                    product: productName,
                    manufacturer: manufacturer,
                    page: window.location.href,
                    userAgent: navigator.userAgent
                };
                
                // Store in localStorage (safe, no database conflicts)
                const clicks = JSON.parse(localStorage.getItem('marketplace_clicks') || '[]');
                clicks.push(clickData);
                localStorage.setItem('marketplace_clicks', JSON.stringify(clicks));
                
                console.log('üìä Affiliate click tracked:', clickData);
            }

            // Setup affiliate tracking (safe version)
            setupAffiliateTracking() {
                // Only add tracking to product pages
                if (!this.isProductPage()) return;
                
                // Add tracking script (safe, no conflicts)
                const trackingScript = document.createElement('script');
                trackingScript.textContent = `
                    // Safe marketplace tracking - no calculator interference
                    window.marketplaceTracking = {
                        track: function(data) {
                            console.log('üìä Marketplace tracking:', data);
                            // Safe tracking implementation
                        }
                    };
                `;
                document.head.appendChild(trackingScript);
            }

            // Add affiliate links to existing product elements
            addAffiliateLinks() {
                // Find product links and convert to affiliate links
                const productLinks = document.querySelectorAll('a[href*="product"], a[href*="buy"]');
                
                productLinks.forEach(link => {
                    const productName = link.textContent || link.getAttribute('title') || '';
                    const manufacturer = this.determineManufacturer(productName);
                    
                    if (manufacturer) {
                        const affiliateLink = this.generateAffiliateLink(productName, manufacturer);
                        if (affiliateLink) {
                            link.href = affiliateLink;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            console.log(`üîó Converted to affiliate link: ${productName}`);
                        }
                    }
                });
            }

            // Show marketplace messages (safe, no calculator interference)
            showMarketplaceMessage(message, type = 'info') {
                // Only show on product pages
                if (!this.isProductPage()) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `marketplace-message marketplace-message-${type}`;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
            }

            // Get marketplace statistics (safe version)
            getMarketplaceStats() {
                const clicks = JSON.parse(localStorage.getItem('marketplace_clicks') || '[]');
                
                return {
                    totalClicks: clicks.length,
                    manufacturers: [...new Set(clicks.map(c => c.manufacturer))],
                    recentClicks: clicks.slice(-10),
                    lastUpdated: new Date().toISOString()
                };
            }
        }

        // Initialize marketplace safely
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - Checking for safe marketplace integration...');
            
            // Only initialize if not on calculator page
            window.marketplace = new SafeMarketplaceIntegration();
            
            // Wait for product data to be loaded before adding buttons
            // This will be called from updateProductDisplay()
        });

        // Export for use in other scripts
        window.SafeMarketplaceIntegration = SafeMarketplaceIntegration;
    </script>

    <!-- ORIGINAL PRODUCT PAGE SCRIPT -->
    <script>
        // Global variables
        let currentProduct = null;
        let isDescriptionExpanded = false;
        let isAdditionalTechExpanded = false;
        let isAdditionalInfoExpanded = false;
        
        // Backend URL configuration - auto-detect based on current location
        const BACKEND_URL = (() => {
            // If running on localhost, use localhost:4000
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:4000';
            }
            // Otherwise use the same origin (works for production if page is on same domain)
            // Or set to your production URL if page is on different domain (e.g., Wix)
            return window.location.origin || 'https://energy-calc-backend.onrender.com';
        })();
        
        console.log('üîß Backend URL configured:', BACKEND_URL);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dynamic Product Page v2.0 initialized (ETL API) - ' + new Date().toISOString());
            loadProductFromURL();
        });

        // Load product data from URL parameters
        function loadProductFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product') || urlParams.get('id');
            
            if (productId) {
                loadProduct(productId);
            } else {
                // Use sample data for testing marketplace features
                loadSampleProduct();
            }
        }

        // Load sample product for testing marketplace features
        function loadSampleProduct() {
            console.log('üîÑ Loading sample product for marketplace testing...');
            
            const sampleProduct = {
                id: 'sample_bosch_dishwasher',
                name: 'Bosch Professional Dishwasher SMI88TS06E',
                sku: 'ETL-SAMPLE-001',
                price: 1299,
                category: 'Commercial Dishwashers',
                brand: 'Bosch',
                power: '2.1kW',
                modelNumber: 'SMI88TS06E',
                energyRating: 'A++',
                efficiency: 'High',
                imageUrl: 'https://images.unsplash.com/photo-1581578731548-c6a0c3f2f2c0?w=600&h=400&fit=crop',
                images: [
                    'https://images.unsplash.com/photo-1581578731548-c6a0c3f2f2c0?w=600&h=400&fit=crop',
                    'https://images.unsplash.com/photo-1581578731548-c6a0c3f2f2c0?w=600&h=400&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1581578731548-c6a0c3f2f2c0?w=600&h=400&fit=crop&crop=top'
                ],
                videos: [
                    'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4'
                ],
                descriptionShort: 'Professional Bosch dishwasher with advanced energy efficiency and superior cleaning performance.',
                descriptionFull: 'The Bosch Professional Dishwasher SMI88TS06E is a top-of-the-line commercial dishwasher designed for high-volume operations. Features advanced water recycling, energy-efficient heating, and superior cleaning performance. ETL certified for maximum energy efficiency.',
                additionalInfo: [
                    'Power Rating: 2.1kW',
                    'Energy Rating: A++',
                    'Efficiency: High',
                    'Brand: Bosch Professional',
                    'Category: Commercial Dishwashers',
                    'Model: SMI88TS06E',
                    'Professional installation recommended',
                    'Comprehensive warranty included'
                ],
                additionalTechInfo: {
                    'Running Cost (Annual)': '‚Ç¨245',
                    'Water per Cycle': '12L',
                    'Water per Year': '4,380L',
                    'Capacity': '14 place settings',
                    'Place Settings': '14 settings',
                    'Source': 'ETL',
                    'Subcategory': 'Commercial Dishwashers',
                    'Installation Type': 'Professional installation recommended',
                    'Warranty Period': '2 years comprehensive warranty',
                    'Certification': 'ETL certified, CE marked',
                    'Maintenance': 'Annual maintenance recommended',
                    'Compatibility': 'Universal compatibility',
                    'Dimensions': '600 x 850 x 600mm',
                    'Weight': '45kg',
                    'Operating Temperature': '45-85¬∞C',
                    'Humidity Range': 'Up to 95% RH',
                    'Noise Level': '49dB',
                    'Safety Features': 'Multiple safety systems included'
                },
                marketingInfo: {
                    'Product Benefits': 'High efficiency design reduces energy costs by 30%',
                    'Customer Value': 'Professional-grade equipment for commercial use',
                    'Usage Tips': 'Regular maintenance ensures optimal performance',
                    'Energy Savings': 'Up to 30% reduction in energy consumption',
                    'ROI Information': 'Payback period typically 2-3 years',
                    'Support': 'Comprehensive technical support available',
                    'Delivery': 'Fast delivery and professional installation',
                    'Financing': 'Flexible payment options available'
                }
            };
            
            currentProduct = sampleProduct;
            updateProductDisplay();
            updateCalculatorWidget();
            
            console.log('‚úÖ Sample product loaded successfully');
        }

        // Load product data
        async function loadProduct(productId) {
            try {
                console.log(`üîÑ Loading product: ${productId}`);
                
                const productData = await getProductData(productId);
                
                if (productData) {
                    currentProduct = productData;
                    updateProductDisplay();
                    updateCalculatorWidget();
                } else {
                    showError('Product not found');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showError('Failed to load product');
            }
        }

        // Get product data from ETL API (working version)
        async function getProductData(productId) {
            try {
                console.log(`üîÑ Fetching ETL product data for: ${productId}`);
                
                // Use BACKEND_URL for API calls (works in both localhost and production)
                const response = await fetch(`${BACKEND_URL}/api/product-widget/${productId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.product) {
                    console.log('‚úÖ Found product in ETL data:', data.product);
                    return transformETLProduct(data.product);
                } else {
                    console.log('‚ùå Product not found in ETL data');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching product data:', error);
                return null;
            }
        }

        // Transform ETL product data to our format (working version)
        // Helper function to normalize and get full image URLs (works for both localhost and production)
        function getImageUrl(imageUrl) {
            if (!imageUrl) {
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2Qzc1N0QiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Qcm9kdWN0IEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
            }
            
            // If it's already a full URL (http/https), use it as is (but encode spaces if needed)
            if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                // URL-encode spaces in the path part of the URL
                try {
                    const url = new URL(imageUrl);
                    const pathParts = url.pathname.split('/');
                    const encodedParts = pathParts.map(part => encodeURIComponent(part));
                    url.pathname = encodedParts.join('/');
                    return url.toString();
                } catch (e) {
                    // If URL parsing fails, just return as is
                    return imageUrl;
                }
            }
            
            // Get the base URL (works for both localhost and production)
            const baseUrl = window.location.origin;
            
            // Normalize path: Convert "Product Placement" to "product-placement" (folder was renamed)
            let normalizedPath = imageUrl;
            if (normalizedPath.includes('Product Placement')) {
                normalizedPath = normalizedPath.replace(/Product Placement/g, 'product-placement');
            }
            
            // URL-encode the path to handle spaces and special characters
            let encodedPath = normalizedPath;
            if (normalizedPath.startsWith('/')) {
                // For absolute paths, encode each segment separately
                const parts = normalizedPath.split('/').filter(p => p);
                encodedPath = '/' + parts.map(part => encodeURIComponent(part)).join('/');
            } else {
                // For relative paths, encode each segment separately
                const parts = normalizedPath.split('/').filter(p => p);
                encodedPath = parts.map(part => encodeURIComponent(part)).join('/');
            }
            
            // If it's a relative path, make it absolute
            if (normalizedPath.startsWith('/')) {
                return `${baseUrl}${encodedPath}`;
            }
            
            // If it's a local path (like "product-placement/Image.jpg"), make it absolute
            return `${baseUrl}/${encodedPath}`;
        }

        function transformETLProduct(product) {
            // Check if product is gas-powered
            const isGas = product.isGas || false;
            const heatingCapacity = product.heatingCapacity || null;
            const fuelType = product.fuelType || 'Electric';
            
            // Determine power display label and value
            const powerLabel = isGas ? 'Heating Capacity' : 'Power Rating';
            const powerValue = isGas && heatingCapacity ? heatingCapacity : product.power;
            const powerDisplay = `${powerValue}kW`;
            
            return {
                id: product.id,
                name: product.name,
                sku: `ETL-${product.id.toUpperCase()}`,
                price: 1500, // Fixed price for display
                category: product.category || 'Energy Products',
                brand: product.brand || 'Unknown',
                power: powerDisplay, // Display version (string)
                powerLabel: powerLabel, // "Power Rating" or "Heating Capacity"
                powerValue: powerValue, // Original numeric value for calculator
                isGas: isGas,
                heatingCapacity: heatingCapacity,
                fuelType: fuelType,
                modelNumber: product.modelNumber || product.id,
                energyRating: product.energyRating || 'A',
                efficiency: product.efficiency || 'High',
                imageUrl: getImageUrl(product.image_url || product.imageUrl),
                images: product.images || [], // From API (includes Wix media)
                videos: product.videos || [], // From API (includes Wix media)
                descriptionShort: `Professional ${product.category || 'Energy Product'} - ${product.brand || 'High-quality'} ${product.name}. ${isGas ? `Gas-powered with ${heatingCapacity || powerValue}kW heating capacity.` : `Energy-efficient design with ${powerValue}kW power rating.`}`,
                descriptionFull: `The ${product.name} is a professional-grade ${product.category || 'energy product'} designed for maximum efficiency and performance. This ${product.brand || 'high-quality'} product delivers exceptional performance while maintaining low operating costs.`,
                additionalInfo: [
                    `${powerLabel}: ${powerDisplay}`,
                    isGas ? `Fuel Type: ${fuelType}` : `Energy Rating: ${product.energyRating || 'A'}`,
                    `Efficiency: ${product.efficiency || 'High'}`,
                    `Brand: ${product.brand || 'Professional'}`,
                    `Category: ${product.category || 'Energy Products'}`,
                    `Model: ${product.modelNumber || product.id}`,
                    'Professional installation recommended',
                    'Comprehensive warranty included'
                ],
                additionalTechInfo: {
                    'Running Cost (Annual)': product.runningCostPerYear ? `‚Ç¨${product.runningCostPerYear.toLocaleString()}` : 'Not specified',
                    'Water per Cycle': product.water_per_cycle_liters ? `${product.water_per_cycle_liters}L` : 'N/A',
                    'Water per Year': product.water_per_year_liters ? `${product.water_per_year_liters}L` : 'N/A',
                    'Capacity': product.capacity_kg ? `${product.capacity_kg}kg` : 'N/A',
                    'Place Settings': product.place_settings ? `${product.place_settings} settings` : 'N/A',
                    'Source': product.source || 'ETL',
                    'Subcategory': product.subcategory || 'General',
                    'Installation Type': 'Professional installation recommended',
                    'Warranty Period': '2 years comprehensive warranty',
                    'Certification': 'ETL certified, CE marked',
                    'Maintenance': 'Annual maintenance recommended',
                    'Compatibility': 'Universal compatibility',
                    'Dimensions': 'Standard industry dimensions',
                    'Weight': 'Varies by model',
                    'Operating Temperature': '-10¬∞C to +40¬∞C',
                    'Humidity Range': 'Up to 95% RH',
                    'Noise Level': 'Low noise operation',
                    'Safety Features': 'Multiple safety systems included'
                },
                marketingInfo: {
                    'Product Benefits': 'High efficiency design reduces energy costs',
                    'Customer Value': 'Professional-grade equipment for commercial use',
                    'Usage Tips': 'Regular maintenance ensures optimal performance',
                    'Energy Savings': 'Up to 30% reduction in energy consumption',
                    'ROI Information': 'Payback period typically 2-3 years',
                    'Support': 'Comprehensive technical support available',
                    'Delivery': 'Fast delivery and professional installation',
                    'Financing': 'Flexible payment options available'
                }
            };
        }

        // Load additional media from JSON file
        async function loadAdditionalMedia() {
            try {
                console.log('üîÑ Loading additional media for:', currentProduct.name);
                const response = await fetch('product-media-data.json');
                if (!response.ok) {
                    console.log('‚ùå No additional media file found, using default media');
                    return;
                }
                
                const mediaData = await response.json();
                const productName = currentProduct.name;
                console.log('üìã Available products in JSON:', Object.keys(mediaData));
                console.log('üîç Looking for product:', productName);
                
                if (mediaData[productName]) {
                    const productMedia = mediaData[productName];
                    console.log('üì∏ Found media data:', productMedia);
                    
                    // Add additional images to the product object
                    if (productMedia.images && productMedia.images.length > 0) {
                        currentProduct.images = productMedia.images;
                        console.log('‚úÖ Added images to currentProduct:', currentProduct.images);
                    }
                    
                    // Add videos to the product object
                    if (productMedia.videos && productMedia.videos.length > 0) {
                        currentProduct.videos = productMedia.videos;
                        console.log('‚úÖ Added videos to currentProduct:', currentProduct.videos);
                    }
                    
                    console.log(`‚úÖ Loaded additional media for ${productName}:`, {
                        images: productMedia.images?.length || 0,
                        videos: productMedia.videos?.length || 0
                    });
                } else {
                    console.log(`‚ùå No additional media found for ${productName}`);
                    console.log('Available products:', Object.keys(mediaData));
                }
            } catch (error) {
                console.log('‚ùå Error loading additional media:', error);
            }
        }

        // Update product display
        async function updateProductDisplay() {
            if (!currentProduct) return;

            // Basic info
            document.getElementById('product-title').textContent = currentProduct.name;
            document.getElementById('product-sku').textContent = `SKU: ${currentProduct.sku}`;
            document.getElementById('product-price').textContent = `‚Ç¨${currentProduct.price.toLocaleString()}`;
            
            // Breadcrumb - make category clickable
            const categoryLink = document.getElementById('breadcrumb-category-link');
            if (categoryLink && currentProduct.category) {
                categoryLink.textContent = currentProduct.category;
                categoryLink.href = `/category-product-page.html?category=${encodeURIComponent(currentProduct.category)}`;
            }
            document.getElementById('breadcrumb-product').textContent = currentProduct.name;

            // Description
            document.getElementById('description-short').textContent = currentProduct.descriptionShort;
            document.getElementById('description-full').textContent = currentProduct.descriptionFull;
            
            // Show read more button if there's additional content
            if (currentProduct.descriptionFull && currentProduct.descriptionFull !== currentProduct.descriptionShort) {
                document.getElementById('read-more-btn').style.display = 'inline-block';
            }

            // Load additional media from JSON file
            await loadAdditionalMedia();

            // Show/hide Watch Video button based on videos availability
            const videoBtn = document.querySelector('.video-btn');
            if (videoBtn) {
                if (currentProduct.videos && currentProduct.videos.length > 0) {
                    videoBtn.style.display = 'inline-block';
                    console.log(`‚úÖ Showing Watch Video button (${currentProduct.videos.length} video(s) available)`);
                } else {
                    videoBtn.style.display = 'none';
                    console.log('‚ö†Ô∏è Hiding Watch Video button (no videos available)');
                }
            }

            // Update media gallery with all available media
            updateMediaGallery(currentProduct);

            // Tech info
            // Update power label for gas products
            const powerLabelEl = document.getElementById('tech-power-label');
            if (powerLabelEl && currentProduct.powerLabel) {
                powerLabelEl.textContent = currentProduct.powerLabel; // "Power Rating" or "Heating Capacity"
            }
            document.getElementById('tech-power').textContent = currentProduct.power;
            document.getElementById('tech-brand').textContent = currentProduct.brand;
            document.getElementById('tech-category').textContent = currentProduct.category;
            document.getElementById('tech-model').textContent = currentProduct.modelNumber;
            document.getElementById('tech-energy-rating').textContent = currentProduct.energyRating;
            document.getElementById('tech-efficiency').textContent = currentProduct.efficiency;

            // Additional info
            const additionalList = document.getElementById('additional-info-list');
            additionalList.innerHTML = '';
            currentProduct.additionalInfo.forEach(info => {
                const li = document.createElement('li');
                li.textContent = info;
                additionalList.appendChild(li);
            });

            // Helper function to get emoji for technical info keys
            const getTechEmoji = (key) => {
                const keyLower = key.toLowerCase();
                if (keyLower.includes('running cost') || keyLower.includes('cost')) return 'üí∂';
                if (keyLower.includes('water')) return 'üíß';
                if (keyLower.includes('capacity') || keyLower.includes('place')) return 'üì¶';
                if (keyLower.includes('power') || keyLower.includes('consumption')) return '‚ö°';
                if (keyLower.includes('rating') || keyLower.includes('efficiency')) return '‚≠ê';
                if (keyLower.includes('installation')) return 'üîß';
                if (keyLower.includes('warranty')) return 'üõ°Ô∏è';
                if (keyLower.includes('certification') || keyLower.includes('certified')) return '‚úÖ';
                if (keyLower.includes('maintenance')) return 'üî®';
                if (keyLower.includes('compatibility')) return 'üîå';
                if (keyLower.includes('dimension') || keyLower.includes('size')) return 'üìè';
                if (keyLower.includes('weight')) return '‚öñÔ∏è';
                if (keyLower.includes('temperature')) return 'üå°Ô∏è';
                if (keyLower.includes('humidity')) return 'üí®';
                if (keyLower.includes('noise')) return 'üîá';
                if (keyLower.includes('safety')) return 'üõ°Ô∏è';
                if (keyLower.includes('source') || keyLower.includes('subcategory')) return 'üìÇ';
                return 'üìã'; // Default emoji
            };

            // Additional technical information
            const additionalTechGrid = document.getElementById('additional-tech-grid');
            additionalTechGrid.innerHTML = '';
            
            Object.entries(currentProduct.additionalTechInfo).forEach(([key, value]) => {
                if (value && value !== 'N/A' && value !== 'Not specified') {
                    const techItem = document.createElement('div');
                    techItem.className = 'additional-tech-item';
                    const emoji = getTechEmoji(key);
                    techItem.innerHTML = `
                        <div class="additional-tech-item-title">${emoji} ${key}</div>
                        <div class="additional-tech-item-value">${value}</div>
                    `;
                    additionalTechGrid.appendChild(techItem);
                }
            });

            // Helper function to get emoji for marketing info keys
            const getMarketingEmoji = (key) => {
                const keyLower = key.toLowerCase();
                if (keyLower.includes('benefit')) return '‚ú®';
                if (keyLower.includes('value') || keyLower.includes('customer')) return 'üíé';
                if (keyLower.includes('tip') || keyLower.includes('usage')) return 'üí°';
                if (keyLower.includes('saving') || keyLower.includes('energy')) return 'üíö';
                if (keyLower.includes('roi') || keyLower.includes('payback')) return 'üìà';
                if (keyLower.includes('support')) return 'üÜò';
                if (keyLower.includes('delivery')) return 'üöö';
                if (keyLower.includes('financing') || keyLower.includes('payment')) return 'üí≥';
                return 'üìå'; // Default emoji
            };

            // Additional information (marketing)
            const additionalInfoGrid = document.getElementById('additional-info-grid');
            additionalInfoGrid.innerHTML = '';
            
            Object.entries(currentProduct.marketingInfo).forEach(([key, value]) => {
                if (value && value !== 'N/A' && value !== 'Not specified') {
                    const infoItem = document.createElement('div');
                    infoItem.className = 'additional-tech-item';
                    const emoji = getMarketingEmoji(key);
                    infoItem.innerHTML = `
                        <div class="additional-tech-item-title">${emoji} ${key}</div>
                        <div class="additional-tech-item-value">${value}</div>
                    `;
                    additionalInfoGrid.appendChild(infoItem);
                }
            });

            // Initialize marketplace integration after product data is loaded
            if (window.marketplace) {
                console.log('üîÑ Initializing marketplace after product data loaded...');
                window.marketplace.initMarketplace();
            }
        }

        // Media Gallery Functions
        let currentMediaIndex = 0;
        let mediaItems = [];

        function updateMediaGallery(product) {
            console.log('üîÑ updateMediaGallery called with product:', product.name);
            console.log('üì∏ Product images:', product.images);
            console.log('üé• Product videos:', product.videos);
            
            // Create media items array
            mediaItems = [];
            
            // Get the best available image (prioritize images array over imageUrl)
            let mainImageUrl = null;
            
            // First, try to get image from images array (usually has real ETL images)
            if (product.images && product.images.length > 0) {
                let images = [];
                try {
                    images = typeof product.images === 'string' 
                        ? JSON.parse(product.images) 
                        : product.images;
                } catch (e) {
                    images = [];
                }
                
                // Find first non-placeholder image
                const realImage = images.find(img => 
                    img && 
                    !img.includes('placeholder.com') && 
                    !img.includes('via.placeholder')
                );
                
                if (realImage) {
                    mainImageUrl = getImageUrl(realImage);
                }
            }
            
            // Fall back to imageUrl if images array doesn't have a real image
            if (!mainImageUrl) {
                const imageUrl = product.imageUrl || product.image_url;
                // Skip placeholder images
                if (imageUrl && 
                    !imageUrl.includes('placeholder.com') && 
                    !imageUrl.includes('via.placeholder')) {
                    mainImageUrl = getImageUrl(imageUrl);
                }
            }
            
            // If still no image, use placeholder
            if (!mainImageUrl) {
                mainImageUrl = getImageUrl(null); // Returns placeholder SVG
            }
            
            // Add main image
            mediaItems.push({
                type: 'image',
                url: mainImageUrl,
                thumbnail: mainImageUrl
            });
            console.log('‚úÖ Added main image:', mainImageUrl);
            
            // Add additional images if available (avoid duplicates and placeholders)
            if (product.images && product.images.length > 0) {
                console.log('üì∏ Processing additional images:', product.images);
                let images = [];
                try {
                    images = typeof product.images === 'string' 
                        ? JSON.parse(product.images) 
                        : product.images;
                } catch (e) {
                    images = [];
                }
                
                images.forEach((imgUrl, index) => {
                    if (!imgUrl) return;
                    console.log(`üì∏ Processing image ${index + 1}:`, imgUrl);
                    const normalizedImgUrl = getImageUrl(imgUrl);
                    // Avoid duplicates and placeholders
                    if (normalizedImgUrl !== mainImageUrl && 
                        !normalizedImgUrl.includes('placeholder.com') &&
                        !normalizedImgUrl.includes('via.placeholder')) {
                        mediaItems.push({
                            type: 'image',
                            url: normalizedImgUrl,
                            thumbnail: normalizedImgUrl
                        });
                        console.log('‚úÖ Added additional image:', normalizedImgUrl);
                    } else {
                        console.log('‚è≠Ô∏è Skipped duplicate or placeholder image:', normalizedImgUrl);
                    }
                });
            } else {
                console.log('‚ùå No additional images found for product');
            }
            
            // Add videos if available
            if (product.videos && product.videos.length > 0) {
                console.log('üé• Processing videos:', product.videos);
                product.videos.forEach((videoUrl, index) => {
                    // Ensure videoUrl is a string
                    const normalizedVideoUrl = typeof videoUrl === 'string' ? videoUrl : String(videoUrl);
                    if (normalizedVideoUrl && normalizedVideoUrl !== 'null' && normalizedVideoUrl !== 'undefined') {
                        mediaItems.push({
                            type: 'video',
                            url: normalizedVideoUrl,
                            thumbnail: normalizedVideoUrl // Use the video URL itself as thumbnail - browsers will show first frame
                        });
                        console.log(`‚úÖ Added video ${index + 1}:`, normalizedVideoUrl);
                    } else {
                        console.log(`‚ö†Ô∏è Skipped invalid video URL:`, videoUrl);
                    }
                });
            } else {
                console.log('‚ùå No videos found for product');
            }
            
            console.log('üìä Total media items:', mediaItems.length);
            
            // If no media, show placeholder
            if (mediaItems.length === 0) {
                showMediaPlaceholder();
                return;
            }
            
            // Update media display
            updateMainMedia();
            updateThumbnails();
            updateDots();
            updateMediaCounter();
        }

        function updateMainMedia() {
            const mainImage = document.getElementById('main-media');
            const mainVideo = document.getElementById('main-media-video');
            const placeholder = document.getElementById('media-placeholder');
            
            // Hide all media elements
            mainImage.style.display = 'none';
            mainVideo.style.display = 'none';
            placeholder.style.display = 'none';
            
            if (mediaItems.length === 0) {
                placeholder.style.display = 'flex';
                return;
            }
            
            const currentMedia = mediaItems[currentMediaIndex];
            
            if (currentMedia.type === 'video') {
                mainVideo.src = currentMedia.url;
                mainVideo.style.display = 'block';
                document.getElementById('play-pause-btn').style.display = 'flex';
            } else {
                mainImage.src = currentMedia.url;
                mainImage.style.display = 'block';
                document.getElementById('play-pause-btn').style.display = 'none';
            }
        }

        function updateThumbnails() {
            const thumbnailsContainer = document.getElementById('media-thumbnails');
            thumbnailsContainer.innerHTML = '';
            
            mediaItems.forEach((media, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = `media-thumbnail ${media.type === 'video' ? 'video' : ''} ${index === currentMediaIndex ? 'active' : ''}`;
                thumbnail.onclick = () => selectMedia(index);
                
                if (media.type === 'video') {
                    // Create video element for video thumbnails
                    const video = document.createElement('video');
                    video.src = media.url;
                    video.muted = true; // Mute for thumbnail
                    video.preload = 'metadata'; // Load first frame
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    
                    // Add play icon overlay
                    const playIcon = document.createElement('div');
                    playIcon.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                    `;
                    playIcon.innerHTML = '‚ñ∂';
                    
                    thumbnail.style.position = 'relative';
                    thumbnail.appendChild(video);
                    thumbnail.appendChild(playIcon);
                } else {
                    // Create image element for image thumbnails
                    const img = document.createElement('img');
                    img.src = media.url; // Use url instead of thumbnail
                    img.alt = `Thumbnail ${index + 1}`;
                    
                    // Add error handling for failed image loads
                    img.onerror = function() {
                        console.error('‚ùå Failed to load thumbnail image:', media.url);
                        // Create a fallback placeholder
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = `
                            width: 100%;
                            height: 100%;
                            background: #f0f0f0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #666;
                            font-size: 12px;
                        `;
                        placeholder.textContent = 'Image';
                        thumbnail.innerHTML = '';
                        thumbnail.appendChild(placeholder);
                    };
                    
                    img.onload = function() {
                        console.log('‚úÖ Thumbnail image loaded:', media.url);
                    };
                    
                    thumbnail.appendChild(img);
                }
                
                thumbnailsContainer.appendChild(thumbnail);
            });
        }

        function updateDots() {
            const dotsContainer = document.getElementById('media-dots');
            dotsContainer.innerHTML = '';
            
            mediaItems.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `media-dot ${index === currentMediaIndex ? 'active' : ''}`;
                dot.onclick = () => selectMedia(index);
                dotsContainer.appendChild(dot);
            });
        }

        function updateMediaCounter() {
            document.getElementById('current-media').textContent = currentMediaIndex + 1;
            document.getElementById('total-media').textContent = mediaItems.length;
        }

        function selectMedia(index) {
            currentMediaIndex = index;
            updateMainMedia();
            updateThumbnails();
            updateDots();
            updateMediaCounter();
        }

        function nextMedia() {
            currentMediaIndex = (currentMediaIndex + 1) % mediaItems.length;
            updateMainMedia();
            updateThumbnails();
            updateDots();
            updateMediaCounter();
        }

        function previousMedia() {
            currentMediaIndex = (currentMediaIndex - 1 + mediaItems.length) % mediaItems.length;
            updateMainMedia();
            updateThumbnails();
            updateDots();
            updateMediaCounter();
        }

        function showMediaPlaceholder() {
            const placeholder = document.getElementById('media-placeholder');
            placeholder.style.display = 'flex';
            placeholder.textContent = 'No media available';
            
            // Hide other elements
            document.getElementById('main-media').style.display = 'none';
            document.getElementById('main-media-video').style.display = 'none';
            document.getElementById('media-thumbnails').innerHTML = '';
            document.getElementById('media-dots').innerHTML = '';
        }

        // Update calculator widget (working version)
        function updateCalculatorWidget() {
            if (!currentProduct) {
                console.log('‚ùå No current product for calculator');
                return;
            }

            console.log('üîÑ Updating calculator widget with product:', currentProduct);
            const iframe = document.getElementById('calculator-iframe');
            
            if (!iframe) {
                console.log('‚ùå Calculator iframe not found');
                return;
            }

            const baseUrl = 'product-energy-widget-glassmorphism.html';
            // Use original numeric powerValue for calculator (check for 0 or invalid)
            const numericPower = currentProduct.powerValue;
            const powerForCalculator = (numericPower && numericPower > 0) 
                ? numericPower.toString() 
                : '0.12';
            
            const params = new URLSearchParams({
                productId: currentProduct.id,
                productName: currentProduct.name,
                productPower: powerForCalculator,
                productBrand: currentProduct.brand,
                productCategory: currentProduct.category,
                productImage: currentProduct.imageUrl,
                v: '2.1', // Version with Find My Rate button
                _t: Date.now() // Cache busting parameter
            });

            const finalUrl = `${baseUrl}?${params.toString()}`;
            console.log('üîÑ Setting calculator iframe src:', finalUrl);
            iframe.src = finalUrl;
        }

        // Toggle description
        function toggleDescription() {
            const shortDesc = document.getElementById('description-short');
            const fullDesc = document.getElementById('description-full');
            const readMoreBtn = document.getElementById('read-more-btn');
            
            if (isDescriptionExpanded) {
                shortDesc.style.display = 'block';
                fullDesc.style.display = 'none';
                readMoreBtn.textContent = 'Read more';
                isDescriptionExpanded = false;
            } else {
                shortDesc.style.display = 'none';
                fullDesc.style.display = 'block';
                readMoreBtn.textContent = 'Read less';
                isDescriptionExpanded = true;
            }
        }

        // Toggle additional technical information
        function toggleAdditionalTech() {
            const panel = document.getElementById('additional-tech-panel');
            const btn = document.getElementById('additional-tech-btn');
            const text = document.getElementById('additional-tech-text');
            const icon = document.getElementById('additional-tech-icon');
            
            if (isAdditionalTechExpanded) {
                panel.classList.remove('show');
                btn.classList.remove('expanded');
                text.textContent = 'Additional Technical Information';
                icon.textContent = '‚ñº';
                isAdditionalTechExpanded = false;
            } else {
                panel.classList.add('show');
                btn.classList.add('expanded');
                text.textContent = 'Hide Technical Information';
                icon.textContent = '‚ñ≤';
                isAdditionalTechExpanded = true;
            }
        }

        // Toggle additional information
        function toggleAdditionalInfo() {
            const panel = document.getElementById('additional-info-panel');
            const btn = document.getElementById('additional-info-btn');
            const text = document.getElementById('additional-info-text');
            const icon = document.getElementById('additional-info-icon');
            
            if (isAdditionalInfoExpanded) {
                panel.classList.remove('show');
                btn.classList.remove('expanded');
                text.textContent = 'Additional Information';
                icon.textContent = '‚ñº';
                isAdditionalInfoExpanded = false;
            } else {
                panel.classList.add('show');
                btn.classList.add('expanded');
                text.textContent = 'Hide Additional Information';
                icon.textContent = '‚ñ≤';
                isAdditionalInfoExpanded = true;
            }
        }

        // Quantity controls
        function increaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            quantityInput.value = parseInt(quantityInput.value) + 1;
        }

        function decreaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            if (parseInt(quantityInput.value) > 1) {
                quantityInput.value = parseInt(quantityInput.value) - 1;
            }
        }

        // Add to cart
        function addToCart() {
            const quantity = document.getElementById('quantity').value;
            console.log(`Adding ${quantity} x ${currentProduct.name} to cart`);
            // Implement cart functionality
            alert(`Added ${quantity} x ${currentProduct.name} to cart!`);
        }

        // Social sharing
        function shareOnFacebook() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }

        function shareOnWhatsApp() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`Check out this product: ${currentProduct.name}`);
            window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
        }

        function shareGeneric() {
            if (navigator.share) {
                navigator.share({
                    title: currentProduct.name,
                    text: currentProduct.descriptionShort,
                    url: window.location.href
                });
            } else {
                // Fallback to copying URL
                navigator.clipboard.writeText(window.location.href);
                alert('URL copied to clipboard!');
            }
        }

        function togglePlayPause() {
            const video = document.getElementById('main-media-video');
            const playIcon = document.getElementById('play-icon');
            
            if (video.paused) {
                video.play();
                playIcon.textContent = '‚è∏';
            } else {
                video.pause();
                playIcon.textContent = '‚ñ∂';
            }
        }

        // Error handling
        function showError(message) {
            document.getElementById('product-title').textContent = 'Error';
            document.getElementById('product-sku').textContent = message;
            console.error(message);
        }

        // Marketplace Functions
        function handleMainProductBuy() {
            console.log('üõí Main product buy clicked');
            const productName = currentProduct ? currentProduct.name : 'Bosch Professional Dishwasher';
            
            // Track the click
            trackMarketplaceClick(productName, 'Main Product');
            
            // Show cart modal instead of external redirect
            showCartModal();
        }

        function showCartModal() {
            const product = currentProduct || {
                name: 'Bosch Professional Dishwasher SMI88TS06E',
                price: 1299,
                imageUrl: 'https://images.unsplash.com/photo-1581578731548-c6a0c3f2f2c0?w=600&h=400&fit=crop'
            };

            // Scroll to top so modal is visible
            window.scrollTo({ top: 0, behavior: 'instant' });
            
            const modal = document.createElement('div');
            modal.className = 'cart-modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: flex-start;
                justify-content: center;
                padding-top: 30px;
                overflow-y: auto;
            `;

            modal.innerHTML = `
                <div class="cart-modal" style="
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    max-height: calc(100vh - 120px);
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    margin-bottom: 50px;
                ">
                    <div class="cart-header" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #e9ecef;
                        padding-bottom: 15px;
                    ">
                        <h3 style="margin: 0; color: #28a745;">üõí Add to Cart</h3>
                        <button onclick="closeCartModal()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #6c757d;
                        ">‚úï</button>
                    </div>
                    
                    <div class="cart-content" style="margin-bottom: 25px;">
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <img src="${product.imageUrl}" alt="${product.name}" style="
                                width: 100px;
                                height: 100px;
                                object-fit: cover;
                                border-radius: 8px;
                            ">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #212529;">${product.name}</h4>
                                <p style="margin: 0; font-size: 24px; font-weight: bold; color: #28a745;">‚Ç¨${product.price.toLocaleString()}</p>
                                <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 14px;">ETL Certified ‚Ä¢ Professional Grade</p>
                            </div>
                        </div>
                        
                        <div class="quantity-selector" style="margin-top: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Quantity:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button onclick="decreaseCartQuantity()" style="
                                    background: #f8f9fa;
                                    border: 2px solid #dee2e6;
                                    border-radius: 6px;
                                    padding: 8px 12px;
                                    cursor: pointer;
                                    font-size: 18px;
                                ">-</button>
                                <input type="number" id="cart-quantity" value="1" min="1" style="
                                    border: 2px solid #dee2e6;
                                    border-radius: 6px;
                                    padding: 8px 12px;
                                    text-align: center;
                                    width: 80px;
                                    font-size: 16px;
                                ">
                                <button onclick="increaseCartQuantity()" style="
                                    background: #f8f9fa;
                                    border: 2px solid #dee2e6;
                                    border-radius: 6px;
                                    padding: 8px 12px;
                                    cursor: pointer;
                                    font-size: 18px;
                                ">+</button>
                            </div>
                        </div>
                        
                        <div class="energy-savings" style="
                            background: #e8f5e8;
                            border: 1px solid #28a745;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        ">
                            <h5 style="margin: 0 0 8px 0; color: #28a745;">üí° Energy Savings</h5>
                            <p style="margin: 0; color: #155724; font-size: 14px;">
                                This ETL-certified product will save you approximately <strong>‚Ç¨245/year</strong> in energy costs compared to standard models.
                            </p>
                        </div>

                        <!-- A. Installation Services - HIDDEN until services are configured -->
                        <!--
                        <div class="service-options" style="margin-top: 20px;">
                            <h5 style="margin: 0 0 15px 0; color: #212529;">üîß Additional Services</h5>
                            <div class="service-option" style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                padding: 12px;
                                border: 2px solid #e9ecef;
                                border-radius: 8px;
                                margin-bottom: 10px;
                                cursor: pointer;
                                transition: border-color 0.3s ease;
                            " onclick="toggleInstallation()">
                                <input type="checkbox" id="installation-service" style="transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #212529;">Professional Installation</div>
                                    <div style="font-size: 14px; color: #6c757d;">Expert installation by certified technicians</div>
                                </div>
                                <div style="font-weight: bold; color: #28a745;">+‚Ç¨150</div>
                            </div>
                            
                            <div class="service-option" style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                padding: 12px;
                                border: 2px solid #e9ecef;
                                border-radius: 8px;
                                cursor: pointer;
                                transition: border-color 0.3s ease;
                            " onclick="toggleWarranty()">
                                <input type="checkbox" id="extended-warranty" style="transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #212529;">Extended Warranty</div>
                                    <div style="font-size: 14px; color: #6c757d;">5-year comprehensive warranty coverage</div>
                                </div>
                                <div style="font-weight: bold; color: #28a745;">+‚Ç¨99</div>
                            </div>
                        </div>
                        -->

                        <!-- B. Financing Options - HIDDEN until financing is configured -->
                        <!--
                        <div class="financing-options" style="
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        ">
                            <h5 style="margin: 0 0 10px 0; color: #212529;">üí≥ Financing Options</h5>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 120px;">
                                    <div style="font-size: 12px; color: #6c757d;">24 months</div>
                                    <div style="font-weight: bold; color: #28a745;">‚Ç¨${Math.ceil(product.price / 24)}/month</div>
                                </div>
                                <div style="flex: 1; min-width: 120px;">
                                    <div style="font-size: 12px; color: #6c757d;">36 months</div>
                                    <div style="font-weight: bold; color: #28a745;">‚Ç¨${Math.ceil(product.price / 36)}/month</div>
                                </div>
                                <div style="flex: 1; min-width: 120px;">
                                    <div style="font-size: 12px; color: #6c757d;">48 months</div>
                                    <div style="font-weight: bold; color: #28a745;">‚Ç¨${Math.ceil(product.price / 48)}/month</div>
                                </div>
                            </div>
                            <p style="margin: 8px 0 0 0; font-size: 12px; color: #6c757d;">
                                * Subject to credit approval. 0% APR available for qualified buyers.
                            </p>
                        </div>
                        -->
                    </div>
                    
                    <!-- C. Related Products -->
                    <div class="related-products" style="margin-top: 20px;">
                        <h5 style="margin: 0 0 15px 0; color: #212529;">üëÄ People who viewed this also viewed</h5>
                        <div id="related-products-container" style="display: flex; gap: 10px; overflow-x: auto;">
                            <!-- Products will be loaded dynamically -->
                            <div style="color: #6c757d; font-size: 12px; padding: 20px;">Loading recommendations...</div>
                        </div>
                    </div>

                    <!-- D. Live Chat Button -->
                    <div class="chat-support" style="margin-top: 15px;">
                        <button onclick="openLiveChat()" style="
                            background: #17a2b8;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                            width: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            üí¨ Ask Questions About This Product
                        </button>
                    </div>
                    
                    <div class="cart-actions" style="
                        display: flex;
                        gap: 15px;
                        justify-content: space-between;
                        margin-top: 20px;
                    ">
                        <button onclick="closeCartModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                            flex: 1;
                        ">Continue Shopping</button>
                        <button onclick="proceedToCheckout()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 600;
                            flex: 2;
                        ">Proceed to Checkout</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Load related products dynamically
            if (currentProduct && currentProduct.category) {
                loadRelatedProducts(currentProduct.id, currentProduct.category);
            } else if (currentProduct && currentProduct.subcategory) {
                loadRelatedProducts(currentProduct.id, currentProduct.subcategory);
            }
            
            // Close modal when clicking overlay
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeCartModal();
                }
            };
        }

        function closeCartModal() {
            const modal = document.querySelector('.cart-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function increaseCartQuantity() {
            const input = document.getElementById('cart-quantity');
            input.value = parseInt(input.value) + 1;
        }

        function decreaseCartQuantity() {
            const input = document.getElementById('cart-quantity');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        function proceedToCheckout() {
            const quantity = document.getElementById('cart-quantity').value;
            const productName = currentProduct ? currentProduct.name : 'Bosch Professional Dishwasher';
            
            // Check for additional services (currently hidden - see TODO in WORK_TODOS.md)
            const installation = document.getElementById('installation-service')?.checked || false;
            const warranty = document.getElementById('extended-warranty')?.checked || false;
            
            console.log(`Proceeding to checkout: ${quantity} x ${productName}`);
            if (installation) console.log('+ Professional Installation (‚Ç¨150)');
            if (warranty) console.log('+ Extended Warranty (‚Ç¨99)');
            
            // Close modal
            closeCartModal();
            
            // Generate affiliate link for actual purchase
            const affiliateLink = generateAffiliateLink(productName);
            
            if (affiliateLink) {
                // Open in new tab for actual purchase
                window.open(affiliateLink, '_blank');
                
                // Show success message
                showMarketplaceMessage('Redirecting to secure checkout...', 'success');
            } else {
                showMarketplaceMessage('Unable to proceed to checkout. Please try again.', 'error');
            }
        }

        // A. Installation Services Functions
        function toggleInstallation() {
            const checkbox = document.getElementById('installation-service');
            const serviceOption = checkbox.closest('.service-option');
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                serviceOption.style.borderColor = '#28a745';
                serviceOption.style.backgroundColor = '#f8fff8';
                console.log('‚úÖ Installation service added (+‚Ç¨150)');
                showMarketplaceMessage('Professional installation added to cart!', 'success');
            } else {
                serviceOption.style.borderColor = '#e9ecef';
                serviceOption.style.backgroundColor = 'transparent';
                console.log('‚ùå Installation service removed');
            }
        }

        function toggleWarranty() {
            const checkbox = document.getElementById('extended-warranty');
            const serviceOption = checkbox.closest('.service-option');
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                serviceOption.style.borderColor = '#28a745';
                serviceOption.style.backgroundColor = '#f8fff8';
                console.log('‚úÖ Extended warranty added (+‚Ç¨99)');
                showMarketplaceMessage('Extended warranty added to cart!', 'success');
            } else {
                serviceOption.style.borderColor = '#e9ecef';
                serviceOption.style.backgroundColor = 'transparent';
                console.log('‚ùå Extended warranty removed');
            }
        }

        // C. Related Products Functions
        function showRelatedProduct(productName) {
            console.log(`üõçÔ∏è Related product clicked: ${productName}`);
            
            // Track related product click
            trackMarketplaceClick(productName, 'Related Product');
            
            // Show product info modal
            const modal = document.createElement('div');
            modal.className = 'related-product-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                ">
                    <h3 style="margin: 0 0 15px 0; color: #212529;">${productName}</h3>
                    <p style="margin: 0 0 20px 0; color: #6c757d;">
                        This is a related ETL-certified product that customers often buy together with the Bosch dishwasher.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="closeRelatedModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                        ">Close</button>
                        <button onclick="viewRelatedProduct('${productName}')" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                        ">View Product</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeRelatedModal();
                }
            };
        }

        function closeRelatedModal() {
            const modal = document.querySelector('.related-product-modal');
            if (modal) {
                modal.remove();
            }
        }

        function viewRelatedProduct(productName) {
            closeRelatedModal();
            closeCartModal();
            
            // Generate affiliate link for related product
            const affiliateLink = generateAffiliateLink(productName);
            
            if (affiliateLink) {
                window.open(affiliateLink, '_blank');
                showMarketplaceMessage(`Opening ${productName}...`, 'success');
            }
        }

        // Load related products dynamically from database
        async function loadRelatedProducts(currentProductId, currentCategory) {
            const container = document.getElementById('related-products-container');
            if (!container) return;
            
            try {
                console.log('üîç Loading related products for category:', currentCategory);
                
                // Fetch products from the same category
                const response = await fetch(`${BACKEND_URL}/api/product-widget/products/search?category=${encodeURIComponent(currentCategory)}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch related products');
                }
                
                const data = await response.json();
                let products = data.products || [];
                
                // Filter out the current product and limit to 6
                products = products
                    .filter(p => p.id !== currentProductId)
                    .slice(0, 6);
                
                if (products.length === 0) {
                    container.innerHTML = '<div style="color: #6c757d; font-size: 12px; padding: 20px;">No related products found</div>';
                    return;
                }
                
                // Render the products
                container.innerHTML = products.map(product => {
                    const imageUrl = getRelatedProductImage(product);
                    const displayPrice = product.price ? `‚Ç¨${product.price.toLocaleString()}` : '';
                    
                    return `
                        <div class="related-product" style="
                            min-width: 120px;
                            max-width: 140px;
                            text-align: center;
                            cursor: pointer;
                            padding: 10px;
                            border: 1px solid #e9ecef;
                            border-radius: 8px;
                            transition: border-color 0.3s ease, transform 0.2s ease;
                            flex-shrink: 0;
                        " onclick="navigateToProduct('${product.id}')"
                           onmouseover="this.style.borderColor='#28a745'; this.style.transform='translateY(-2px)';"
                           onmouseout="this.style.borderColor='#e9ecef'; this.style.transform='translateY(0)';">
                            <div style="
                                width: 70px; 
                                height: 70px; 
                                background: #f8f9fa; 
                                border-radius: 4px; 
                                margin: 0 auto 8px;
                                overflow: hidden;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <img src="${imageUrl}" 
                                     alt="${product.name}" 
                                     style="max-width: 100%; max-height: 100%; object-fit: contain;"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='üì¶';">
                            </div>
                            <div style="font-size: 11px; font-weight: 600; color: #212529; 
                                        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                 title="${product.name}">
                                ${truncateName(product.name, 15)}
                            </div>
                            ${displayPrice ? `<div style="font-size: 11px; color: #28a745; margin-top: 2px;">${displayPrice}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
                console.log(`‚úÖ Loaded ${products.length} related products`);
                
            } catch (error) {
                console.error('‚ùå Error loading related products:', error);
                container.innerHTML = '<div style="color: #6c757d; font-size: 12px; padding: 20px;">Unable to load recommendations</div>';
            }
        }
        
        // Helper: Get image URL for related product
        function getRelatedProductImage(product) {
            // Check various image fields
            if (product.imageUrl && product.imageUrl.length > 5) {
                if (product.imageUrl.startsWith('http')) return product.imageUrl;
                return `${BACKEND_URL}/${product.imageUrl}`;
            }
            if (product.image_url && product.image_url.length > 5) {
                if (product.image_url.startsWith('http')) return product.image_url;
                return `${BACKEND_URL}/${product.image_url}`;
            }
            if (product.images && product.images.length > 0) {
                const firstImage = product.images[0];
                if (firstImage.startsWith('http')) return firstImage;
                return `${BACKEND_URL}/${firstImage}`;
            }
            // Return placeholder
            return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70"><rect fill="%23f8f9fa" width="70" height="70"/><text x="35" y="40" text-anchor="middle" fill="%236c757d" font-size="24">üì¶</text></svg>';
        }
        
        // Helper: Truncate product name
        function truncateName(name, maxLength) {
            if (!name) return 'Product';
            if (name.length <= maxLength) return name;
            return name.substring(0, maxLength) + '...';
        }
        
        // Navigate to a product page
        function navigateToProduct(productId) {
            console.log('üîó Navigating to product:', productId);
            closeCartModal();
            
            // Build the URL with the product ID
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('product', productId);
            
            // Navigate to the product page
            window.location.href = currentUrl.toString();
        }

        // D. Live Chat Functions
        function openLiveChat() {
            console.log('üí¨ Live chat opened');
            
            // Track chat interaction
            trackMarketplaceClick('Live Chat', 'Support Request');
            
            // Show chat modal
            const modal = document.createElement('div');
            modal.className = 'chat-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #17a2b8;">üí¨ Live Chat Support</h3>
                        <button onclick="closeChatModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #212529;">Product: ${currentProduct ? currentProduct.name : 'Bosch Professional Dishwasher'}</h4>
                        <p style="margin: 0; color: #6c757d; font-size: 14px;">
                            Our ETL experts are here to help with any questions about this product, installation, energy savings, or financing options.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin: 0 0 10px 0; color: #212529;">Quick Questions:</h5>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button onclick="askQuickQuestion('installation')" style="
                                background: #e9ecef;
                                border: 1px solid #dee2e6;
                                border-radius: 6px;
                                padding: 10px;
                                cursor: pointer;
                                text-align: left;
                            ">üîß Installation requirements?</button>
                            <button onclick="askQuickQuestion('energy')" style="
                                background: #e9ecef;
                                border: 1px solid #dee2e6;
                                border-radius: 6px;
                                padding: 10px;
                                cursor: pointer;
                                text-align: left;
                            ">‚ö° Energy savings calculation?</button>
                            <button onclick="askQuickQuestion('financing')" style="
                                background: #e9ecef;
                                border: 1px solid #dee2e6;
                                border-radius: 6px;
                                padding: 10px;
                                cursor: pointer;
                                text-align: left;
                            ">üí≥ Financing options?</button>
                            <button onclick="askQuickQuestion('warranty')" style="
                                background: #e9ecef;
                                border: 1px solid #dee2e6;
                                border-radius: 6px;
                                padding: 10px;
                                cursor: pointer;
                                text-align: left;
                            ">üõ°Ô∏è Warranty coverage?</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <p style="margin: 0 0 15px 0; color: #6c757d; font-size: 14px;">
                            Or start a live chat with our ETL specialists:
                        </p>
                        <button onclick="startLiveChat()" style="
                            background: #17a2b8;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: 600;
                        ">Start Live Chat</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeChatModal();
                }
            };
        }

        function closeChatModal() {
            const modal = document.querySelector('.chat-modal');
            if (modal) {
                modal.remove();
            }
        }

        function askQuickQuestion(questionType) {
            const responses = {
                'installation': 'Professional installation is recommended for this ETL-certified dishwasher. Our certified technicians will ensure proper electrical and plumbing connections, maximizing energy efficiency.',
                'energy': 'This Bosch dishwasher will save approximately ‚Ç¨245/year compared to standard models. The ETL certification ensures maximum energy efficiency and water conservation.',
                'financing': 'We offer flexible financing options: 24 months (‚Ç¨55/month), 36 months (‚Ç¨37/month), or 48 months (‚Ç¨28/month). 0% APR available for qualified buyers.',
                'warranty': 'This product comes with a 2-year comprehensive warranty. Extended warranty options are available for additional coverage up to 5 years.'
            };
            
            showMarketplaceMessage(responses[questionType], 'info');
            closeChatModal();
        }

        function startLiveChat() {
            closeChatModal();
            showMarketplaceMessage('Connecting you with our ETL specialists...', 'info');
            
            // In a real implementation, this would integrate with your live chat system
            // For now, we'll simulate it
            setTimeout(() => {
                showMarketplaceMessage('Live chat is now active! Our ETL expert will assist you shortly.', 'success');
            }, 2000);
        }

        function trackMarketplaceClick(productName, clickType) {
            const clickData = {
                timestamp: new Date().toISOString(),
                product: productName,
                clickType: clickType,
                page: window.location.href,
                userAgent: navigator.userAgent
            };
            
            // Store in localStorage
            const clicks = JSON.parse(localStorage.getItem('marketplace_clicks') || '[]');
            clicks.push(clickData);
            localStorage.setItem('marketplace_clicks', JSON.stringify(clicks));
            
            console.log('üìä Marketplace click tracked:', clickData);
        }

        function generateAffiliateLink(productName) {
            // Simple affiliate link for Bosch products
            const affiliateId = 'ETL_MARKETPLACE_001';
            const baseUrl = 'https://www.bosch.com';
            
            return `${baseUrl}/products?affiliate=${affiliateId}&source=greenways_market&product=${encodeURIComponent(productName)}`;
        }

        function showMarketplaceMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `marketplace-message marketplace-message-${type}`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // Show video (enhanced with actual video data)
        // Financial Incentives Functions
        async function loadFinancialIncentivesData(productId) {
            // Use the same API endpoint as the calculator to get product with grants
            try {
                const response = await fetch(`${BACKEND_URL}/api/product-widget/${productId}`);
                if (!response.ok) {
                    console.log(`‚ùå API returned ${response.status} for product ${productId}`);
                    return null;
                }
                const data = await response.json();
                if (data.success && data.product) {
                    console.log('‚úÖ Loaded product with grants from API:', data.product.id);
                    return data.product;
                }
                return null;
            } catch (error) {
                console.error('Error loading product from API:', error);
                return null;
            }
        }

        async function showFinancialIncentives() {
            if (!currentProduct) {
                alert('No product loaded. Please wait for the product to load.');
                return;
            }

            const modal = document.getElementById('financial-incentives-modal');
            const content = document.getElementById('financial-incentives-content');
            
            // Show modal
            modal.style.display = 'block';
            
            // Load financial incentives data from API (same as calculator)
            const productId = currentProduct.id;
            const product = await loadFinancialIncentivesData(productId);
            
            if (!product) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #666; font-size: 16px;">No financial incentives data available for this product.</p>
                        <p style="color: #999; font-size: 14px; margin-top: 10px;">Product ID: ${productId}</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">The calculator may show incentives if available. Please check the calculator section below.</p>
                    </div>
                `;
                return;
            }
            
            console.log('‚úÖ Found product with grants:', product.id, product.name);

            // Extract data from master database
            const grants = product.grants || [];
            const collectionAgencies = product.collectionAgencies || [];
            const runningCostPerYear = product.runningCostPerYear || 0;
            const power = product.power || 0;
            const energyRating = product.energyRating || 'N/A';
            const efficiency = product.efficiency || 'N/A';
            
            // Calculate energy savings (assuming 30% savings for energy-efficient products)
            const annualSavings = runningCostPerYear * 0.3;
            const monthlySavings = annualSavings / 12;
            const dailySavings = annualSavings / 365;
            const lifetimeSavings = annualSavings * 10; // Assuming 10-year lifetime
            
            // Build energy savings object
            const energySavings = {
                annualRunningCost: runningCostPerYear,
                annualSavings: annualSavings,
                monthlySavings: monthlySavings,
                dailySavings: dailySavings,
                energyEfficiency: `Up to 30% reduction in energy consumption`,
                paybackPeriod: runningCostPerYear > 0 ? `${Math.round(1500 / annualSavings)}-${Math.round(2000 / annualSavings)} years` : 'N/A',
                lifetimeSavings: lifetimeSavings,
                power: power,
                energyRating: energyRating,
                efficiency: efficiency
            };
            
            // Build HTML content
            let html = '';
            
            // Energy Savings Section
            if (energySavings) {
                html += `
                    <h3>üí° Energy Savings</h3>
                    <div class="financial-card">
                        <h4>Annual Energy Savings</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Daily Savings</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">‚Ç¨${energySavings.dailySavings?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Monthly Savings</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">‚Ç¨${energySavings.monthlySavings?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Annual Savings</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">‚Ç¨${energySavings.annualSavings?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Lifetime Savings</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">‚Ç¨${energySavings.lifetimeSavings?.toLocaleString() || '0'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <div style="margin-bottom: 10px;"><strong>Annual Running Cost:</strong> ‚Ç¨${energySavings.annualRunningCost?.toLocaleString() || '0'}</div>
                            <div style="margin-bottom: 10px;"><strong>Energy Efficiency:</strong> ${energySavings.energyEfficiency || 'N/A'}</div>
                            <!-- Payback Period hidden - calculation too complex for all product types -->
                        </div>
                    </div>
                `;
            }
            
            // Grants Section
            if (grants.length > 0) {
                html += `
                    <h3>üí∂ Available Grants</h3>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 18px; color: #28a745; font-weight: bold; margin-bottom: 15px;">
                            Total Grants Value: ${product.grantsCurrency || 'EUR'} ${product.grantsTotal?.toLocaleString() || '0'} (${product.grantsCount || 0} grant${product.grantsCount !== 1 ? 's' : ''})
                        </div>
                `;
                
                grants.forEach(grant => {
                    html += `
                        <div class="grant-item">
                            <h5>${grant.name || 'Grant'}</h5>
                            <div class="grant-amount">${grant.currency || 'EUR'} ${grant.amount?.toLocaleString() || '0'}</div>
                            <p style="color: #666; margin: 10px 0;">${grant.description || ''}</p>
                            ${grant.requirements && grant.requirements.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <strong>Requirements:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                                        ${grant.requirements.map(req => `<li>${req}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${grant.validUntil ? `<div style="margin-top: 5px; color: #dc3545;"><strong>Valid until:</strong> ${grant.validUntil}</div>` : ''}
                            ${grant.processingTime ? `<div style="margin-top: 5px; color: #666;"><strong>Processing time:</strong> ${grant.processingTime}</div>` : ''}
                            ${grant.contactInfo ? `<div style="margin-top: 5px; color: #666;"><strong>Contact:</strong> ${grant.contactInfo}</div>` : ''}
                            ${grant.applicationUrl ? `<a href="${grant.applicationUrl}" target="_blank" style="display: inline-block; margin-top: 10px; color: #007bff; text-decoration: none; font-weight: 600;">Apply Now ‚Üí</a>` : ''}
                            ${grant.additionalInfo ? `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; color: #666; font-size: 14px;">${grant.additionalInfo}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Collection Agencies Section
            if (collectionAgencies.length > 0) {
                html += `
                    <h3>‚ôªÔ∏è Collection & Recycling</h3>
                    <div class="financial-card">
                        <div style="font-size: 16px; color: #28a745; font-weight: bold; margin-bottom: 15px;">
                            Total Collection Value: ${product.collectionCurrency || 'EUR'} ${product.collectionIncentiveTotal?.toLocaleString() || '0'} (${product.collectionAgenciesCount || 0} option${product.collectionAgenciesCount !== 1 ? 's' : ''})
                        </div>
                `;
                
                collectionAgencies.forEach(agency => {
                    html += `
                        <div class="grant-item" style="margin-bottom: 15px;">
                            <h5 style="color: #007bff; margin-bottom: 5px;">${agency.agencyName || 'Collection Agency'}</h5>
                            <div style="display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;">
                                ${agency.agencyType ? `<span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${agency.agencyType}</span>` : ''}
                                ${agency.collectionMethod ? `<span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${agency.collectionMethod}</span>` : ''}
                                ${agency.incentiveType ? `<span style="background: #d4edda; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #155724;">${agency.incentiveType}</span>` : ''}
                            </div>
                            ${agency.incentiveAmount ? `<div style="color: #28a745; font-weight: bold; font-size: 18px; margin: 10px 0;">Value: ${agency.currency || 'EUR'} ${agency.incentiveAmount.toLocaleString()}</div>` : ''}
                            <p style="color: #666; margin: 10px 0;">${agency.description || ''}</p>
                            ${agency.requirements && agency.requirements.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <strong>Requirements:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                                        ${agency.requirements.map(req => `<li>${req}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${agency.collectionArea ? `<div style="margin-top: 5px; color: #666;"><strong>Area:</strong> ${agency.collectionArea}</div>` : ''}
                            ${agency.contactInfo ? `<div style="margin-top: 5px; color: #666;"><strong>Contact:</strong> ${agency.contactInfo}</div>` : ''}
                            ${agency.processingTime ? `<div style="margin-top: 5px; color: #666;"><strong>Processing:</strong> ${agency.processingTime}</div>` : ''}
                            ${agency.website ? `<a href="${agency.website}" target="_blank" style="display: inline-block; margin-top: 10px; color: #007bff; text-decoration: none; font-weight: 600;">Visit Website ‚Üí</a>` : ''}
                            ${agency.additionalBenefits && agency.additionalBenefits.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px;">
                                    <strong style="color: #155724;">Additional Benefits:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px; color: #155724;">
                                        ${agency.additionalBenefits.map(benefit => `<li>${benefit}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${agency.ecoCertification ? `<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 5px; color: #856404; font-size: 12px;"><strong>‚úì</strong> ${agency.ecoCertification}</div>` : ''}
                            ${agency.circularEconomyImpact ? `<div style="margin-top: 5px; color: #666; font-size: 12px;"><strong>Circular Economy Impact:</strong> ${agency.circularEconomyImpact}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            if (!energySavings && grants.length === 0 && collectionAgencies.length === 0) {
                html = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #666; font-size: 16px;">No financial incentives data available for this product.</p>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function closeFinancialIncentives() {
            const modal = document.getElementById('financial-incentives-modal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('financial-incentives-modal');
            if (event.target === modal) {
                closeFinancialIncentives();
            }
        }

        function showVideo() {
            if (!currentProduct) {
                console.log('No product loaded');
                return;
            }
            
            console.log(`Showing video for product: ${currentProduct.name}`);
            
            // Check if product has videos
            if (currentProduct.videos && currentProduct.videos.length > 0) {
                // Create a modal to display the video
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                const videoContainer = document.createElement('div');
                videoContainer.style.cssText = `
                    position: relative;
                    max-width: 90%;
                    max-height: 90%;
                    background: white;
                    border-radius: 8px;
                    overflow: hidden;
                `;
                
                const video = document.createElement('video');
                video.src = currentProduct.videos[0]; // Use first video
                video.controls = true;
                video.autoplay = true;
                video.style.cssText = `
                    width: 100%;
                    height: auto;
                    max-width: 800px;
                    max-height: 600px;
                `;
                
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '‚úï';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 20px;
                    cursor: pointer;
                    z-index: 10001;
                `;
                
                closeBtn.onclick = () => {
                    document.body.removeChild(modal);
                };
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
                videoContainer.appendChild(video);
                videoContainer.appendChild(closeBtn);
                modal.appendChild(videoContainer);
                document.body.appendChild(modal);
                
                console.log(`‚úÖ Playing video: ${currentProduct.videos[0]}`);
            } else {
                alert('No video available for this product yet.');
            }
        }

        // Back button functionality - safe navigation back to previous page
        function goBack() {
            // Check if there's history to go back to
            if (window.history.length > 1) {
                console.log('üîô Going back in browser history');
                window.history.back();
            } else {
                // Fallback: redirect to energy audit widget if no history
                console.log('‚ö†Ô∏è No history available, redirecting to audit widget');
                const auditWidgetUrl = 'energy-audit-widget-v3-embedded-test.html';
                window.location.href = auditWidgetUrl;
            }
        }
    </script>
</body>
</html>
