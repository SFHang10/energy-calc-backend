<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Energy Audit Widget - Interactive Layout Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .layout-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        /* Interactive Layout Area */
        .layout-canvas {
            width: 100%;
            height: 400px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            position: relative;
            background: #f8f9fa;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="%23e9ecef" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
            overflow: hidden;
        }

        .layout-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0.7;
        }

        /* Product Placement */
        .product-icon {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: move;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            border: 3px solid white;
        }

        .product-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .product-icon[data-type="oven"] {
            background: #fd7e14;
        }

        .product-icon[data-type="fridge"] {
            background: #28a745;
        }

        .product-icon[data-type="freezer"] {
            background: #17a2b8;
        }

        .product-icon[data-type="lights"] {
            background: #ffc107;
            color: #333;
        }

        .product-icon[data-type="motor"] {
            background: #6c757d;
        }

        /* Product Counters */
        .product-counter {
            position: relative;
            margin-left: 50px;
            margin-bottom: 10px;
        }

        .counter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .counter-btn {
            background: #007bff;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .counter-btn:hover {
            background: #0056b3;
        }

        .counter-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        }

        .product-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .product-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .product-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
        }

        .product-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .product-item.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .product-item-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .product-item-name {
            font-size: 12px;
            font-weight: 600;
        }

        .add-product-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .add-product-btn:hover {
            background: #1e7e34;
        }

        .add-product-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Layout Options */
        .layout-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .layout-btn {
            background: white;
            border: 2px solid #dee2e6;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .layout-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Summary Section */
        .summary-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .summary-item-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .summary-item-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .summary-item.money {
            border-left-color: #28a745;
        }

        .summary-item.savings {
            border-left-color: #fd7e14;
        }

        .analyze-btn {
            background: #fd7e14;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 20px;
        }

        .analyze-btn:hover {
            background: #e8590c;
        }

        /* Space Status */
        .space-status {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .status-indicator {
            font-weight: 600;
            font-size: 14px;
        }

        .status-indicator.current {
            color: #dc3545;
        }

        .status-indicator.efficient {
            color: #28a745;
        }

        /* Side-by-Side Comparison Layout */
        .comparison-layout {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .space-layout-side {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .space-layout-side .layout-canvas {
            height: 350px;
            border: 2px dashed #dee2e6;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .space-layout-side .layout-canvas.current-space {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5, #ffebee);
        }

        .space-layout-side .layout-canvas.efficient-space {
            border-color: #28a745;
            background: linear-gradient(135deg, #f0fff4, #e8f5e8);
        }

        .vs-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }

        .vs-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            position: relative;
        }

        .vs-circle::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 2px;
            background: linear-gradient(to right, #dc3545, #007bff, #28a745);
            left: -20px;
            z-index: -1;
        }

        .vs-text {
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* Button Row Layout */
        .button-row {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .button-row .add-product-btn {
            flex: 1;
            max-width: 200px;
        }

        .standard-step-icon {
            background: #6c757d;
        }

        .efficient-step-icon {
            background: #28a745;
        }

        .standard-btn {
            background: linear-gradient(135deg, #8d9298, #6c757d);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .standard-btn:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
        }

        .efficient-btn {
            background: linear-gradient(135deg, #34d058, #28a745);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .efficient-btn:hover {
            background: linear-gradient(135deg, #2c974b, #1e7e34);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        /* Product Addition Panel */
        .product-addition-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        /* Comparison Section */
        .comparison-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 20px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 40px;
            align-items: center;
        }

        .comparison-current,
        .comparison-efficient {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
        }

        .comparison-current {
            border-left: 5px solid #dc3545;
        }

        .comparison-efficient {
            border-left: 5px solid #28a745;
        }

        .comparison-current h3,
        .comparison-efficient h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        .comparison-arrow {
            text-align: center;
        }

        .arrow {
            font-size: 48px;
            color: #007bff;
            font-weight: bold;
        }

        .savings-label {
            color: #007bff;
            font-weight: 600;
            margin-top: 10px;
        }

        .comparison-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .comparison-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .comparison-stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .comparison-stat-label {
            font-size: 12px;
            color: #666;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .product-selector {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .comparison-arrow {
                order: -1;
            }

            .arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè† Energy Audit Widget</h1>
            <p>Interactive tool to assess your home or restaurant's energy usage and find savings opportunities</p>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2 class="section-title">Select Layout Type</h2>
            <div class="layout-options">
                <button class="layout-btn active" onclick="selectLayout('home')">üè† Home Layout</button>
                <button class="layout-btn" onclick="selectLayout('kitchen')">üç≥ Kitchen Layout</button>
                <button class="layout-btn" onclick="selectLayout('restaurant')">üè™ Restaurant Layout</button>
            </div>

            <h3 class="section-title">Add Products to Your Space</h3>
            <div class="product-selector">
                <div class="product-item" data-type="oven" onclick="selectProductType('oven')">
                    <div class="product-item-icon">üî•</div>
                    <div class="product-item-name">Ovens</div>
                </div>
                <div class="product-item" data-type="fridge" onclick="selectProductType('fridge')">
                    <div class="product-item-icon">üßä</div>
                    <div class="product-item-name">Refrigerators</div>
                </div>
                <div class="product-item" data-type="freezer" onclick="selectProductType('freezer')">
                    <div class="product-item-icon">‚ùÑÔ∏è</div>
                    <div class="product-item-name">Freezers</div>
                </div>
                <div class="product-item" data-type="lights" onclick="selectProductType('lights')">
                    <div class="product-item-icon">üí°</div>
                    <div class="product-item-name">Lighting</div>
                </div>
                <div class="product-item" data-type="motor" onclick="selectProductType('motor')">
                    <div class="product-item-icon">‚öôÔ∏è</div>
                    <div class="product-item-name">Motors</div>
                </div>
                <div class="product-item" data-type="dishwasher" onclick="selectProductType('dishwasher')">
                    <div class="product-item-icon">üìª</div>
                    <div class="product-item-name">Dishwashers</div>
                </div>
            </div>
            <!-- Dual Button Layout -->
            <div class="button-row">
                <button class="add-product-btn standard-btn" id="addStandardBtn" onclick="addStandardProduct()" disabled>
                    + Add Electrical Appliance
                </button>
                <button class="add-product-btn efficient-btn" id="addEfficientBtn" onclick="addEfficientProduct()" disabled>
                    + Add Low Energy Appliance
                </button>
            </div>
        </div>

        <!-- Side-by-Side Layout Comparison -->
        <div class="comparison-layout">
            <!-- Current Space -->
            <div class="space-layout-side">
                <h2 class="section-title">üî¥ Current Space</h2>
                <div class="layout-canvas" id="currentLayoutCanvas">
                    <!-- Current space layout -->
                </div>
                
                <!-- Current Space Counters -->
                <div id="currentProductCounters"></div>
                
                <!-- Status Indicator -->
                <div class="space-status">
                    <span class="status-indicator current">üî¥ Electrical Appliances</span>
                </div>
            </div>

            <!-- VS Divider -->
            <div class="vs-divider">
                <div class="vs-circle">
                    <span class="vs-text">VS</span>
                </div>
            </div>

            <!-- Energy Efficient Space -->
            <div class="space-layout-side">
                <h2 class="section-title">üü¢ Energy Efficient Space</h2>
                <div class="layout-canvas" id="efficientLayoutCanvas">
                    <!-- Energy efficient space layout -->
                </div>
                
                    <!-- Efficient Space Counters -->
                    <div id="efficientProductCounters"></div>
                    
                    <!-- Status Indicator -->
                    <div class="space-status">
                        <span class="status-indicator efficient">üü¢ Low Energy Appliances</span>
                    </div>
            </div>
        </div>

        <!-- Product Addition Panel -->
        <div class="product-addition-panel">
            <h2 class="section-title">üõ†Ô∏è Add Energy Efficient Products</h2>
            <p style="color: #666; text-align: center; margin-bottom: 20px;">
                Select energy-efficient products to replace your current appliances and see the savings!
            </p>
            <div id="productAdditionArea">
                <p style="color: #666; text-align: center; margin-top: 50px;">
                    Select a product type above and click "Add Energy Efficient Product" to place it in your efficient space.
                </p>
            </div>
        </div>

        <!-- Comparison Section -->
        <div class="comparison-section" id="comparisonSection" style="display: none;">
            <div class="comparison-grid">
                <div class="comparison-current">
                    <h3>üî¥ Current Space (Standard Products)</h3>
                    <div class="comparison-stats" id="currentStats"></div>
                </div>
                <div class="comparison-arrow">
                    <div class="arrow">‚Üí</div>
                    <div class="savings-label">SAVINGS</div>
                </div>
                <div class="comparison-efficient">
                    <h3>üü¢ Energy Efficient Space</h3>
                    <div class="comparison-stats" id="efficientStats"></div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h2 class="section-title">Energy Audit Summary</h2>
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-item">
                    <div class="summary-item-title">Total Products</div>
                    <div class="summary-item-value" id="totalProducts">0</div>
                </div>
                <div class="summary-item money">
                    <div class="summary-item-title">Annual Energy Cost</div>
                    <div class="summary-item-value" id="annualCost">‚Ç¨0</div>
                </div>
                <div class="summary-item savings">
                    <div class="summary-item-title">Potential Savings</div>
                    <div class="summary-item-value" id="potentialSavings">‚Ç¨0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-item-title">Energy Rating</div>
                    <div class="summary-item-value" id="energyRating">D</div>
                </div>
            </div>
            
            <button class="analyze-btn" onclick="analyzeEnergyUsage()">
                üîç Analyze Energy Usage & Get Recommendations
            </button>
        </div>
    </div>

    <script>
        // Global state
        let currentLayout = 'home';
        let selectedProductType = null;
        let placedProducts = {};
        let productCounter = 0;
        let currentSpaceType = 'current'; // 'current' or 'efficient'
        let currentSpaceData = {};
        let efficientSpaceData = {};

        // Product type configurations
        const productTypes = {
            oven: {
                icon: 'üî•',
                name: 'Oven',
                typicalPower: 3.0,
                defaultCount: 1,
                color: '#fd7e14'
            },
            fridge: {
                icon: 'üßä',
                name: 'Refrigerator',
                typicalPower: 0.2,
                defaultCount: 1,
                color: '#28a745'
            },
            freezer: {
                icon: '‚ùÑÔ∏è',
                name: 'Freezer',
                typicalPower: 0.3,
                defaultCount: 1,
                color: '#17a2b8'
            },
            lights: {
                icon: 'üí°',
                name: 'Light Fixtures',
                typicalPower: 0.05,
                defaultCount: 10,
                color: '#ffc107'
            },
            motor: {
                icon: '‚öôÔ∏è',
                name: 'Motor',
                typicalPower: 0.12,
                defaultCount: 1,
                color: '#6c757d'
            },
            dishwasher: {
                icon: 'üìª',
                name: 'Dishwasher',
                typicalPower: 1.5,
                defaultCount: 1,
                color: '#6f42c1'
            }
        };

        // Layout configurations
        const layouts = {
            home: {
                name: 'Home Layout',
                image: null, // Would load actual layout image
                description: 'Typical residential layout'
            },
            kitchen: {
                name: 'Kitchen Layout',
                image: null, // Would load kitchen layout image
                description: 'Commercial or residential kitchen'
            },
            restaurant: {
                name: 'Restaurant Layout',
                image: null, // Would load restaurant layout image
                description: 'Commercial restaurant/kitchen setup'
            }
        };

        // Initialize the widget
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† Energy Audit Widget initialized');
            updateDisplay();
        });

        // Layout selection
        function selectLayout(layoutType) {
            currentLayout = layoutType;
            
            // Update active button
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="selectLayout('${layoutType}')"]`).classList.add('active');
            
            // Update layout canvas
            updateLayoutDisplay();
            console.log(`üìê Layout changed to: ${layouts[layoutType].name}`);
        }

        // Product type selection
        function selectProductType(type) {
            selectedProductType = type;
            
            // Update visual selection
            document.querySelectorAll('.product-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Enable both add buttons
            document.getElementById('addStandardBtn').disabled = false;
            document.getElementById('addEfficientBtn').disabled = false;
            
            console.log(`üîß Selected product type: ${productTypes[type].name}`);
        }

        // Add product to current space (for initial setup)
        function addProduct() {
            if (!selectedProductType) return;
            
            productCounter++;
            const productId = `${selectedProductType}_${productCounter}`;
            const productConfig = productTypes[selectedProductType];
            
            // Add to current space products
            if (!currentSpaceProducts[selectedProductType]) {
                currentSpaceProducts[selectedProductType] = {
                    count: 0,
                    totalPower: 0,
                    products: []
                };
            }
            
            currentSpaceProducts[selectedProductType].count++;
            currentSpaceProducts[selectedProductType].totalPower += productConfig.typicalPower;
            currentSpaceProducts[selectedProductType].products.push(productId);
            
            // Create product icon in current space canvas
            createProductIcon(productId, selectedProductType, 'currentSpace');
            
            // Update current space display
            updateCurrentSpaceDisplay();
            
            console.log(`‚ûï Added ${productConfig.name} to current space`);
        }

        // Add electrical appliance to current space
        function addStandardProduct() {
            if (!selectedProductType) return;
            
            productCounter++;
            const productId = `current_${selectedProductType}_${productCounter}`;
            const productConfig = productTypes[selectedProductType];
            
            // Add to current space products
            if (!currentSpaceProducts[selectedProductType]) {
                currentSpaceProducts[selectedProductType] = {
                    count: 0,
                    totalPower: 0,
                    products: []
                };
            }
            
            currentSpaceProducts[selectedProductType].count++;
            currentSpaceProducts[selectedProductType].totalPower += productConfig.typicalPower;
            currentSpaceProducts[selectedProductType].products.push(productId);
            
            // Create product icon in current space canvas
            createProductIcon(productId, selectedProductType, 'currentSpace');
            
            // Update current space display
            updateCurrentSpaceDisplay();
            
            console.log(`‚ûï Added electrical appliance: ${productConfig.name} to current space`);
        }

        // Add energy efficient product to efficient space
        function addEfficientProduct() {
            if (!selectedProductType) return;
            
            efficientProductCounter++;
            const productId = `efficient_${selectedProductType}_${efficientProductCounter}`;
            
            // Get efficient version of product (typically 50-70% less power)
            const baseConfig = productTypes[selectedProductType];
            const efficientPower = baseConfig.typicalPower * 0.6; // 40% less power for efficient version
            
            // Add to efficient space products
            if (!efficientSpaceProducts[selectedProductType]) {
                efficientSpaceProducts[selectedProductType] = {
                    count: 0,
                    totalPower: 0,
                    products: []
                };
            }
            
            efficientSpaceProducts[selectedProductType].count++;
            efficientSpaceProducts[selectedProductType].totalPower += efficientPower;
            efficientSpaceProducts[selectedProductType].products.push(productId);
            
            // Create product icon in efficient space canvas
            createProductIcon(productId, selectedProductType, 'efficientSpace', efficientPower);
            
            // Update efficient space display
            updateEfficientSpaceDisplay();
            
            // Auto-update comparison
            updateComparisonStats();
            
            console.log(`‚ûï Added low energy appliance: ${baseConfig.name} to efficient space (${efficientPower.toFixed(2)}kW vs ${baseConfig.typicalPower}kW)`);
        }

        // Create product icon on canvas
        function createProductIcon(productId, productType, targetSpace, customPower = null) {
            const canvasId = targetSpace === 'currentSpace' ? 'currentLayoutCanvas' : 'efficientLayoutCanvas';
            const canvas = document.getElementById(canvasId);
            const productConfig = productTypes[productType];
            
            const icon = document.createElement('div');
            icon.className = 'product-icon';
            icon.dataset.type = productType;
            icon.dataset.productId = {productId};
            icon.dataset.space = targetSpace;
            
            // Different styling for efficient products
            if (targetSpace === 'efficientSpace') {
                icon.style.backgroundColor = '#28a745';
                icon.style.border = '3px solid #1e7e34';
                icon.title = `Efficient ${productConfig.name}: ${(customPower || productConfig.typicalPower)}kW`;
            } else {
                icon.style.backgroundColor = productConfig.color;
                icon.title = `${productConfig.name}: ${productConfig.typicalPower}kW`;
            }
            
            icon.innerHTML = productConfig.icon;
            
            // Random position within canvas
            const rect = canvas.getBoundingClientRect();
            const x = Math.random() * (rect.width - 40);
            const y = Math.random() * (rect.height - 40);
            
            icon.style.left = `${x}px`;
            icon.style.top = `${y}px`;
            
            // Make draggable
            icon.draggable = true;
            icon.addEventListener('dragstart', handleDragStart);
            icon.addEventListener('dragend', handleDragEnd);
            
            // Click to show product details
            icon.addEventListener('click', () => showProductDetails(productId, productType, targetSpace));
            
            canvas.appendChild(icon);
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.style.opacity = '0.5';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedElement = null;
        }

        // Update layout display
        function updateLayoutDisplay() {
            const canvas = document.getElementById('layoutCanvas');
            const layoutName = layouts[currentLayout].name;
            
            // Clear existing products
            canvas.innerHTML = '';
            
            // Add layout-specific styling
            canvas.style.background = currentLayout === 'home' 
                ? 'linear-gradient(135deg, #8e44ad, #3498db)' 
                : currentLayout === 'kitchen'
                    ? 'linear-gradient(135deg, #e67e22, #d35400)'
                    : 'linear-gradient(135deg, #27ae60, #2ecc71)';
            
            // Re-add existing products
            Object.keys(placedProducts).forEach(productType => {
                placedProducts[productType].products.forEach(productId => {
                    createProductIcon(productId, productType);
                });
            });
        }

        // Update product counters display
        function updateProductCounters() {
            const container = document.getElementById('productCounters');
            container.innerHTML = '';
            
            Object.keys(placedProducts).forEach(productType => {
                const productData = placedProducts[productType];
                const productConfig = productTypes[productType];
                
                const counterDiv = document.createElement('div');
                counterDiv.className = 'product-counter';
                counterDiv.innerHTML = `
                    <div class="counter-controls">
                        <button class="counter-btn" onclick="decreaseCount('${productType}')">-</button>
                        <span class="counter-value">${productData.count}</span>
                        <button class="counter-btn" onclick="increaseCount('${productType}')">+</button>
                    </div>
                    <div class="product-label">${productConfig.icon} ${productData.count}x ${productConfig.name}</div>
                `;
                
                container.appendChild(counterDiv);
            });
        }

        // Increase/decrease product count
        function increaseCount(productType) {
            const productData = placedProducts[productType];
            const productConfig = productTypes[productType];
            
            productCounter++;
            const productId = `${productType}_${productCounter}`;
            
            productData.count++;
            productData.totalPower += productConfig.typicalPower;
            productData.products.push(productId);
            
            createProductIcon(productId, productType);
            updateDisplay();
        }

        function decreaseCount(productType) {
            const productData = placedProducts[productType];
            if (productData.count <= 0) return;
            
            productData.count--;
            productData.totalPower -= productTypes[productType].typicalPower;
            const removedProduct = productData.products.pop();
            
            // Remove from canvas
            const element = document.querySelector(`[data-product-id="${removedProduct}"]`);
            if (element) element.remove();
            
            updateDisplay();
        }

        // Update all displays
        function updateDisplay() {
            updateProductCounters();
            updateSummary();
        }

        // Update summary calculations
        function updateSummary() {
            let totalProducts = 0;
            let totalAnnualCost = 0;
            
            Object.keys(placedProducts).forEach(productType => {
                const productData = placedProducts[productType];
                totalProducts += productData.count;
                
                // Calculate annual cost (simplified: power * hours * days * rate)
                const annualHours = 8760; // Full year
                const electricityRate = 0.15; // ‚Ç¨/kWh
                totalAnnualCost += productData.totalPower * annualHours * electricityRate;
            });
            
            // Update summary display
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('annualCost').textContent = `‚Ç¨${Math.round(totalAnnualCost)}`;
            
            // Calculate potential savings (simplified - assume 30% savings with efficient appliances)
            const potentialSavings = totalAnnualCost * 0.3;
            document.getElementById('potentialSavings').textContent = `‚Ç¨${Math.round(potentialSavings)}`;
            
            // Calculate energy rating
            let energyRating = 'A';
            if (totalAnnualCost > 2000) energyRating = 'D';
            else if (totalAnnualCost > 1500) energyRating = 'C';
            else if (totalAnnualCost > 1000) energyRating = 'B';
            
            document.getElementById('energyRating').textContent = energyRating;
        }

        // Show product details (placeholder)
        function showProductDetails(productId, productType) {
            const productConfig = productTypes[productType];
            alert(`Product Details:\n\nType: ${productConfig.name}\nPower: ${productConfig.typicalPower}kW\nID: ${productId}`);
        }

        // Analyze energy usage
        function analyzeEnergyUsage() {
            const totalProducts = Object.values(placedProducts).reduce((sum, data) => sum + data.count, 0);
            
            if (totalProducts === 0) {
                alert('Please add some products to your space before analyzing energy usage.');
                return;
            }
            
            // In a full implementation, this would:
            // 1. Send data to your existing calculator API
            // 2. Get government subsidy recommendations
            // 3. Show efficient alternative products
            // 4. Generate detailed savings report
            
            alert(`Energy Analysis Complete!\n\nTotal Products: ${totalProducts}\nAnnual Cost: ‚Ç¨${Math.round(Object.values(placedProducts).reduce((sum, data) => sum + data.totalPower * 8760 * 0.15, 0))}\nPotential Savings: ‚Ç¨${Math.round(Object.values(placedProducts).reduce((sum, data) => sum + data.totalPower * 8760 * 0.15 * 0.3, 0))}\n\nüåü Open calculator for detailed recommendations!`);
        }

        // Export configuration (for integration)
        function exportConfiguration() {
            return {
                layout: currentLayout,
                products: Object.keys(placedProducts).map(type => ({
                    type: type,
                    count: placedProducts[type].count,
                    totalPower: placedProducts[type].totalPower
                })),
                summary: {
                    totalProducts: Object.values(placedProducts).reduce((sum, data) => sum + data.count, 0),
                    totalPower: Object.values(placedProducts).reduce((sum, data) => sum + data.totalPower, 0),
                    annualCost: Object.values(placedProducts).reduce((sum, data) => sum + data.totalPower * 8760 * 0.15, 0)
                }
            };
        }

        // Toggle between current and efficient space
        function toggleSpaceType(spaceType) {
            currentSpaceType = spaceType;
            
            // Save current space data when switching
            if (spaceType === 'efficient') {
                currentSpaceData = {...placedProducts};
                clearCurrentSpace();
            } else if (spaceType === 'current') {
                efficientSpaceData = {...placedProducts};
                loadSpace(currentSpaceData);
            }
            
            // Update UI
            updateSpaceUI();
            
            console.log(`üîÑ Switched to ${spaceType} space configuration`);
        }

        // Update space UI elements
        function updateSpaceUI() {
            const spaceTitle = document.getElementById('spaceTitle');
            const productTitle = document.getElementById('productTitle');
            const statusIndicator = document.querySelector('.status-indicator');
            
            if (currentSpaceType === 'current') {
                spaceTitle.textContent = 'Your Current Space';
                productTitle.textContent = 'Add Standard Products';
                statusIndicator.innerHTML = 'üî¥ Current Space - Standard Products';
                statusIndicator.className = 'status-indicator current';
            } else {
                spaceTitle.textContent = 'Your Energy Efficient Space';
                productTitle.textContent = 'Add Energy Efficient Products';
                statusIndicator.innerHTML = 'üü¢ Energy Efficient Space - Low Energy Products';
                statusIndicator.className = 'status-indicator efficient';
            }
            
            // Update active button
            document.querySelectorAll('.layout-options .layout-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (currentSpaceType === 'current') {
                document.querySelector('[onclick="toggleSpaceType(\'current\')"]').classList.add('active');
            } else {
                document.querySelector('[onclick="toggleSpaceType(\'efficient\')"]').classList.add('active');
            }
        }

        // Clear current space for switching
        function clearCurrentSpace() {
            const canvas = document.getElementById('layoutCanvas');
            canvas.innerHTML = '';
            placedProducts = {};
            updateDisplay();
        }

        // Load space data
        function loadSpace(spaceData) {
            clearCurrentSpace();
            
            Object.keys(spaceData).forEach(productType => {
                const productData = spaceData[productType];
                
                placedProducts[productType] = {
                    count: productData.count,
                    totalPower: productData.totalPower,
                    products: []
                };
                
                // Recreate product icons
                for (let i = 0; i < productData.count; i++) {
                    productCounter++;
                    const productId = `${productType}_${productCounter}`;
                    placedProducts[productType].products.push(productId);
                    createProductIcon(productId, productType);
                }
            });
            
            updateDisplay();
        }

        // Show comparison between current and efficient spaces
        function showComparison() {
            if (Object.keys(currentSpaceData).length === 0 || Object.keys(efficientSpaceData).length === 0) {
                alert('Please configure both Current Space and Energy Efficient Space before comparing.');
                return;
            }
            
            const comparisonSection = document.getElementById('comparisonSection');
            const currentStats = document.getElementById('currentStats');
            const efficientStats = document.getElementById('efficientStats');
            
            // Calculate current space stats
            const currentTotalProducts = Object.values(currentSpaceData).reduce((sum, data) => sum + data.count, 0);
            const currentTotalPower = Object.values(currentSpaceData).reduce((sum, data) => sum + data.totalPower, 0);
            const currentAnnualCost = currentTotalPower * 8760 * 0.15;
            
            // Calculate efficient space stats
            const efficientTotalProducts = Object.values(efficientSpaceData).reduce((sum, data) => sum + data.count, 0);
            const efficientTotalPower = Object.values(efficientSpaceData).reduce((sum, data) => sum + data.totalPower, 0);
            const efficientAnnualCost = efficientTotalPower * 8760 * 0.15;
            
            // Calculate savings
            const annualSavings = currentAnnualCost - efficientAnnualCost;
            const monthlySavings = annualSavings / 12;
            const paybackPeriod = currentAnnualCost > efficientAnnualCost ? 
                (currentAnnualCost * 0.3) / annualSavings : 'N/A'; // Simplified payback calculation
            
            // Update current space stats
            currentStats.innerHTML = `
                <div class="comparison-stat">
                    <div class="comparison-stat-value">${currentTotalProducts}</div>
                    <div class="comparison-stat-label">Total Products</div>
                </div>
                <div class="comparison-stat">
                    <div class="comparison-stat-value">${currentTotalPower.toFixed(1)}kW</div>
                    <div class="comparison-stat-label">Total Power</div>
                </div>
                <div class="comparison-stat">
                    <div class="comparison-stat-value">‚Ç¨${Math.round(currentAnnualCost)}</div>
                    <div class="comparison-stat-label">Annual Cost</div>
                </div>
                <div class="comparison-stat">
                    <div class="comparison-stat-value">D</div>
                    <div class="comparison-stat-label">Efficiency Rating</div>
                </div>
            `;
            
            // Update efficient space stats
            efficientStats.innerHTML = `
                <div class="comparison-stat">
                    <div class="comparison-stat-value">${efficientTotalProducts}</div>
                    <div class="comparison-stat-label">Total Products</div>
                </div>
                <div class="comparison-stat">
                    <div class="comparison-stat-value">${efficientTotalPower.toFixed(1)}kW</div>
                    <div class="comparison-stat-label">Total Power</div>
                </div>
                <div class="comparison-stat">
                    <div class="comparison-stat-value">‚Ç¨${Math.round(efficientAnnualCost)}</div>
                    <div class="comparison-stat-label">Annual Cost</div>
                </div>
                <div class="comparison-stat">
                    <div class="comparison-stat-value">A+</div>
                    <div class="comparison-stat-label">Efficiency Rating</div>
                </div>
            `;
            
            // Show comparison section
            comparisonSection.style.display = 'block';
            
            // Update savings in arrow
            const savingsLabel = document.querySelector('.savings-label');
            savingsLabel.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; color: #28a745;">
                    ‚Ç¨${Math.round(annualSavings)}/year
                </div>
                <div style="font-size: 12px; margin-top: 5px;">
                    ‚Ç¨${Math.round(monthlySavings)}/month
                </div>
                <div style="font-size: 10px; margin-top: 5px;">
                    ${paybackPeriod !== 'N/A' ? paybackPeriod.toFixed(1) + ' year payback' : 'Immediate savings'}
                </div>
            `;
            
            // Scroll to comparison
            comparisonSection.scrollIntoView({ behavior: 'smooth' });
            
            console.log(`üìä Comparison created - Annual savings: ‚Ç¨${annualSavings}`);
        }

        // Initialize UI state
        function initializeUI() {
            updateSpaceUI();
        }

        // Initialize the widget
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† Energy Audit Widget with side-by-side comparison initialized');
            
            // Set up canvas styles
            document.getElementById('currentLayoutCanvas').classList.add('current-space');
            document.getElementById('efficientLayoutCanvas').classList.add('efficient-space');
            
            // Add sample current space products
            initializeSampleCurrentSpace();
            
            // Update displays
            updateCurrentSpaceDisplay();
            updateEfficientSpaceDisplay();
        });

        // Initialize widget with sample current space
        function initializeSampleCurrentSpace() {
            const sampleProducts = [
                {type: 'oven', count: 1},
                {type: 'fridge', count: 1},
                {type: 'freezer', count: 1},
                {type: 'lights', count: 8},
                {type: 'dishwasher', count: 1}
            ];

            sampleProducts.forEach(sample => {
                for (let i = 0; i < sample.count; i++) {
                    addProductToSpace(sample.type, 'current');
                }
            });
        }

        // Add product to specified space (for initialization)
        function addProductToSpace(productType, space) {
            const products = space === 'current' ? currentSpaceProducts : efficientSpaceProducts;
            const power = space === 'current' ? 
                productTypes[productType].typicalPower : 
                productTypes[productType].typicalPower * 0.6;
            
            if (!products[productType]) {
                products[productType] = {
                    count: 0,
                    totalPower: 0,
                    products: []
                };
            }
            
            const productId = `${space}_${productType}_${space === 'current' ? ++productCounter : ++efficientProductCounter}`;
            
            products[productType].count++;
            products[productType].totalPower += power;
            products[productType].products.push(productId);
            
            createProductIcon(productId, productType, space === 'current' ? 'currentSpace' : 'efficientSpace', space === 'efficient' ? power : null);
        }

        // Import configuration (for integration)
        function importConfiguration(config) {
            placedProducts = {};
            
            config.products.forEach(product => {
                placedProducts[product.type] = {
                    count: product.count,
                    totalPower: product.totalPower,
                    products: []
                };
                
                // Generate product IDs
                for (let i = 0; i < product.count; i++) {
                    productCounter++;
                    const productId = `${product.type}_${productCounter}`;
                    placedProducts[product.type].products.push(productId);
                    createProductIcon(productId, product.type);
                }
            });
            
            updateDisplay();
        }
    </script>
</body>
</html>
